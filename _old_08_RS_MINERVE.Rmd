# Hydrological-Hydraulic Modeling {#RSMinerveMODELS}

Hydrological-hydraulic models are used for different purposes, including for the design of basin plans while taking into consideration different development options, for the study of effective water resources management schemes while taking into consideration the different types of sectoral users and uses of water in a basin (ideally also including minimal environmental flows), and for the detailed study of basin-scale climate impacts and their repercussions.

This Chapter introduces combined hydrologic and hydraulic modeling using the freely available graphical modeling environment RSMinerve [@rsminerve_software; @rsminerve_um; @rsminerve_tm][^rs_minerve-1]. Figure \@ref(fig:rsminerveModelPreview) shows a screen shot of a model of the Gunt river basin setup in RSMinerve as a teaser.

[^rs_minerve-1]: The reader is advised to consult the user manual and familiarizes himself or herself with the walk through examples that are discussed and presented there. They give a solid first hands-on introduction about the basic functionalities of the modeling environment. 

```{r rsminerveModelPreview,echo = FALSE, fig.cap = 'Screenshot of an RSMinerve model setup for Gunt river basin.'}
knitr::include_graphics('_bookdown_files/FIG_RS_MINERVE/rsminerveModelPreview_lr.png')
```

It should be noted that other modeling packages exist for hydrological-hydraulic modeling. Among others, these include

-   [WEAP: Water Evaluation and Planning System](https://www.weap21.org){target="_blank"},
-   [SWAT: Soil & Water Assessment Tool](https://swat.tamu.edu){target="_blank"}, and
-   [Mike Hydro Basin](https://www.mikepoweredbydhi.com/products/mike-hydro-basin){target="_blank"}

As some if not most of these modeling packages are license-based, the advantage of using the combination of [QGIS](https://www.qgis.org/en/site/), [R](https://www.r-project.org) and [RSMinerve](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve.html) is that this is a completely free software suit for any user and use scenario.

Departing from catchment GIS data, RS Minerve allows to quickly develop, test and calibrate different types of lumped conceptual precipitation runoff models while taking into account the evolution of water balances in glacier, snow, surface and subsurface compartments over time and in different sections in the catchment under consideration. This is demonstrated here for the Gunt River Basin in the Pamirs (see Chapter \@ref(GuntRB) for more information).

The main goal in this Chapter is to familiarize the student on how to setup such model, calibrate and validate it for past and current climate conditions and then to **study climate change impacts in the basin**.



## Prerequisites {#section-rsminerve-prerequisites}
Before delving into this section of the course material, you should have at least:   

* RS Minerve installed [How to install RS Minerve](#section-quickguides-how-to-download-and-install-rsminerve). This tutorial was written using RS Minerve 2.9.1.0. 
* Read chapters 1 and 2 from the RS Minerve user manual [@rsminerve_um] (the manual can be downloaded from the CREALP website, see Section [How to install RS Minerve](#section-quickguides-how-to-download-and-install-rsminerve)).    
* Familiarize yourself with RS Minerve by following Example 1 in the RS Minerve user manual.  
* Read the HBV model description in the RS Minerve technical manual (Chapter 2.7) [@rsminerve_tm].   

You may have to dig deeper into the user manual and the technical manual within the frame of the course but the above points are the minimum requirement to get started.   
If you fulfill the prerequisites, you should be able to do the tutorial with the minimal description in the modeling section. However, detailed step-by-step descriptions are linked for each task. 



## Recap: Hydrological response {#section-rsminerve-why-model-introduction}
Why do we do hydrological modeling? Typically we want to know how much river flow we can expect at a given time in the future so we can plan our water consumption ahead, harness against floods or implement measures against droughts. So how can we forecast river discharge? For example, one could use the long term seasonal average discharge as the likely future discharge. However, in some years we have high discharge and in some years we have low discharge (Figure \@ref(fig:fig-discharge-nauvalisoy)). How to tell when you have which discharge?

```{r fig-discharge-nauvalisoy, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, fig.cap="Discharge of the Nauvalisoy river."}
library(tidyverse)
library(lubridate)
library(tsibble)
library(riversCentralAsia)
seasonal_discharge <- ChirchikRiverBasin %>%
  dplyr::filter(code == "16298", 
                year(date) > 1984, 
                year(date) < 1993) %>%
  mutate(yearmonth = yearmonth(date)) %>%
  group_by(yearmonth) %>%
  summarize(`Q [m3/s]` = mean(data))
ggplot(seasonal_discharge) + 
  geom_line(aes(yearmonth, `Q [m3/s]` * 60*60*24*365*10^(-6))) + 
  labs(x = "", y = "Q [10^6 m3/a]") + 
  ylim(0, 500) + 
  theme_bw()
```

Let's go back to the water balance: Where does the water in the river come from? Precipitation. When we compare precipitation and discharge time series we see that the two are related (Figure \@ref(fig:fig-precipitation-nauvalisoy)).    
```{r fig-precipitation-nauvalisoy, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, fig.cap="Discharge (red) and precipitation (grey) in the Nauvalisoy catchment."}
climate <- load_minerve_input_csv("./data/SyrDarya/Chirchiq/RSMinerve/ERA5_Nauvalisoy_1981_2013.csv")
seasonal_precipitation <- mutate(climate, yearmonth = yearmonth(date)) %>%
 dplyr::filter(type == "P") %>%
 group_by(yearmonth) %>%
 summarize(`P [mm]` = sum(value)) %>%
 dplyr::filter(year(yearmonth) > 1984,
               year(yearmonth) < 1993)
ggplot(seasonal_precipitation) +
 geom_col(aes(yearmonth, `P [mm]`), fill = "gray") +
 geom_line(data = seasonal_discharge,
           aes(yearmonth, `Q [m3/s]` * 60*60*24*365*10^(-6))) +
 labs(x = "", y = "P [mm], Q [10^6 m3/a]") +
 ylim(0, 500) + 
 theme_bw()
```

Higher precipitation in the catchment is positively correlated with higher discharge in the river with a delay. Or in other words: The discharge is the catchments hydrological response to precipitation. The relationship is can be expressed as follows: 

$$
Q \propto P \cdot K
$$    

In words this reads: Discharge (Q) is proportional to precipitation (P) times a transfer function (K) that defines the delay of the signal. The transfer function K describes how precipitation becomes river discharge and depends on the catchment characteristics, importantly on the storage capacity of the catchment. In reality, the transformation of precipitation to discharge is quite complex but we can simplify the reality and come up with a basic conceptual model of our river catchment: a large bath tube with the area of the catchment and an outlet at the bottom called the *linear reservoir model* (Figure \@ref(fig:fig-from-catchment-to-bucket)).  

```{r fig-from-catchment-to-bucket, echo=FALSE, fig.show = "hold", out.width="90%", fig.align="center", fig.cap="From the real-life system (left) to a linear reservoir (right)."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_fromCatchmentToBucket.png")
```

The linear reservoir model describes the discharge from the reservoir as linearly proportional to the storage in the reservoir:   

$$
Q(t) = 1/k \cdot S(t)
$$

Where Q is discharge, S is the storage and k is a constant called storage coefficient depending on the storage capacity of the reservoir. If k is small, the stored water will run out quickly, if k is large, the stored water will run out slowly. (t) indicate time dependent variables, i.e. variables that change over time.   
Substitute the linear reservoir equation into the water balance:  

$$
P = Q + dS/dt \Leftrightarrow P = Q + k \cdot dQ/dt
$$

Where P is the *excess* precipitation, i.e. the precipitation that is not intercepted by plants or ponds but contributes to discharge. The above is a differential equation and can be re-arranged:  

$$(P-Q) \cdot dt = k \cdot dQ$$

and integrated and solved for Q(t) (dig out your mathematics!). In the example in the box below we discredited the water balance with the linear relationship between discharge and storage change in the reservoir:

$$\frac{P_{t_1}+P_{t_1}}{2} - \frac{Q_{t1}+Q_{t_2}}{2} = \frac{k}{t_2-t_1} \cdot (Q_{t_2}-Q_{t_1})$$
and solved the equation for $Q_{t_2}$ (Inspiration from @Pedersen1980).   
We assume that at the beginning of our experiment, we don't have a discharge as the bucket is empty.   

$$Q(t) = P(t) \cdot (1-e^{(-t/k)})$$

This is the equation for the rising discharge curve. Once you turn off the recharge of the reservoir (once you stop pouring water into the bucket), the discharge from the bucket can be described as:  

$$Q(t) = Q^* \cdot e^{-\tau/k}$$

Which describes the receding limb of the hydrograph ([What is a hydrograph](#section-quickguides-what-is-a-hydrograph)) with $\tau$ being the time since the recharge stopped. 

Understanding the linear reservoir model is a prerequisite for hydrological modeling. That is why we propose the following exercise for you to do at home as a preparation for class.   

```{r, eval = "html", label="linear-reservoir-example", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "exercise" <div class = "exercise" id="kc4.1"> 
<h3 class = "right">Ex4.1</h3> 
<h3 class = "left">Exercise: The Linear Reservoir</h3> 
<p><strong>Part 1: Experimental setup</strong></p>
<p>To understand the flow of water through a reservoir, you will build a bucket model yourself at home from materials that you have at hand and measure recharge as well as discharge from the bucket. You will then make a numerical model of your real bucket model and simulate discharge. Think through the experiment and answer the following questions:</p>
<p><ul>
  <li>What will determine the flow through your bucket?</li>
  <li>What do you need to measure?</li>
  <li>How can you measure it?</li>
  <li>What materials you will need to set up the experiment?</li>
  <li>Where will you get the water from and can you re-use it after the experiment?</li>
</ul></p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-exercise1">Solution to task 1</a></p> 
<p></p>
<p><strong>Part 2: Perform the experiment</strong></p>
<p>Set up the experiment and pour water into your improvised reservoir. Take care to pour with a continuous speed over a short time period. You may have to repeat the experiment a few times (see also notes on measurement accuracy in the <a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-exercise1">solutions of part 1 of this exercise</a>. The outcome of the experiment is a time series of discharge measurements.</p>   
<p>You can watch a video of the experiment <a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#solution-task2-perform-experiment">here</a> if you cannot perform the experiment yourself.</p>
<p></p>
<p><strong>Part 3: Simulate the experiment</strong></p>
<p>The figure below shows the measured discharge from the experimental data shown in the table above. We have implemented a discretized version of a linear reservoir model for you which shows the simulated discharge (grey bars) of a recharge event (blue bars). Play with the storage parameter by moving the slider and see how the simulated discharge changes based on the storage parameter of the simulated catchment. Can you reproduce the measured discharge? If you cannot find a perfect match between measurements and simulation results: What could be the reasons? (If you see an empty window below this text, go to the <a href="http://34.251.168.23:3838/linearReservoirExampleApp/">web app</a> directly to do the exercise).</p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#solution-task3-simulate">Solution to task 3.</a></p>
</div>')
```

```{r, echo=FALSE}
knitr::include_app("http://34.251.168.23:3838/linearReservoirExampleApp/", 
                   height = "800px")
```
App code available on [GitHub](https://github.com/hydrosolutions/linear_reservoir_model_example_app). 

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.1"> 
<h3 class = "right">T4.1</h3> 
<h3 class= "left">Non-linear reservoirs</h3> 
<p>Discuss with your colleague(s): </p>
<p><ul>
  <li>What happens to the discharge curve if the outlet of the reservoir is not at the bottom but somewhere in the middle of the receptacle wall? </li>
  <li>What do you need to measure?</li>
  <li>What happens if the receptacle is filled with sand?</li>
  <li>What happens if you add another linear reservoir to the outlet of the first one, i.e. make a cascade of linear reservoirs?</li>
</ul></p> 
</div>')
```


## Recap: The general modeling process {#section-general-modelling-process}
Hydrological modeling is an iterative process (see Figure \@ref(fig:iterative-modelling-process). At the beginning, the purpose of the model has to be defined. The model goal determines the spatial and temporal resolution of the hydrological model. E.g. for analyzing the impact of climate change on seasonal, regional flows we are interested in the seasonal flow volumes whereas a model used for early warnings from floods requires high temporal resolution and a high model performance for threshold overflows. See for example @bloschl_scale_1995 for a thorough discussion of scales in hydrological modeling. Please note that the definition of the model goal also determines the performance criteria the model has to fulfill in order to be judged suitable for its purpose. As a next step, data about the catchment is gathered (see for example basin characterization in the Chapter [Case Studies](#CaseStudies)) and a first conceptual model of the dominant flow processes in the basin is drafted (e.g. low peaks and significant base flow point to large storage capacity in the basin whereas high peaks and low base flow indicate small storage capacity in the basin). The conceptual model of the river catchment is then implemented with a mathematical model (e.g. the HBV model in RS Minerve) and parameterized as well as possible (i.e. using reasonable estimates for initial parameter values). The model is then calibrated and validated (i.e. tested with a previously unseen data set) as described further below If the performance criteria for the model calibration are satisfied, a conscientious modeler performs a sensitivity analysis to gain confidence in the model. From each of these steps, the modeler can (and generally has to) go back to a previous step to gather more data, modify the conceptual model, adapt the model implementation, re-calibrate the model and/or re-evaluate the model sensitivity. Also, the modeler is aware of the inherent uncertainties of the data and the model (see for example @refsgaard_uncertainty_2007 for a discussion on how to include uncertainties in the modeling process). The described steps produce a model (or an ensemble of models) that satisfy the performance criteria, only now the modeler can start actually using the model for the purpose it was implemented for.          
```{r iterative-modelling-process, echo=FALSE, out.width="100%", fig.align="center", fig.cap="The modelling process is iterative."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_modelling_process.png")
```

Modeling is an involved process requiring highly specialized knowledge and skills. A modeler has the responsibility to clearly state the underlying assumptions, uncertainties and limitations of their model, especially if it is to be used in decision making. This book chapter will guide you through the modeling process with the example of the Nauvalisoy catchment.  

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.2"> 
<h3 class = "right">T4.2</h3> 
<h3 class= "left">What is a good model?</h3> 
<p>Discuss with your colleague(s): </p>
<p>Imagine you work for a government and have to judge if the hydrological model you mandated is of good quality. How would you decide whether or not to accept the model?</p> 
</div>')
```


## Data Preparation and Setup {#section-rsminerve-data-preparation}

The data used in this Chapter can be accessed on the public GitHub repository [Applied Modeling of Hydrological Systems in Central Asia](https://github.com/tobiassiegfried/HydrologicalModeling_CentralAsia) and the ./data/AmuDarya/Gunt/ folder in there. It is advisable that the user downloads the data and sets up a similar data directory structure on their local machines.

### Examining and Understanding the GIS Data

As demonstrated in the Examples of the User Manual, RS Minerve does not necessarily require GIS input files for setting up models. These can also be setup and wired by hand. However, individual subbasins that contribute to flow in a larger catchment have different characteristics that need to be derived from spatial data, i.e. GIS files. For example, subbasin areas, river stretch lengths, terrain slopes, etc., are all required data in an RS Minerve model. These data could either be typed in by hand for each subbasin or automatically inserted via the GIS Import option. The latter method is much more convenient and is demonstrated here[^rs_minerve-2].

[^rs_minerve-2]: We assume that the basic steps of GIS basin delineation have been carried out as described in Chapter \@ref(Chapter-RetrievalAnalysisHydroData) and the Section \@ref(GeospatialData) there. We thus depart here assuming that the basin outlet (i.e. the location of the discharge gauge), the basin shape file as well as the digital elevation model are available.

First, we load the required packages in `R`.

```{r message=FALSE}
# Loading required packages
## Tidy data wrangling
library(tidyverse)
library(here)
library(timetk)
library(tidymodels)
library(lubridate)
library(timetk)
## riversCentralAsia Package
library('riversCentralAsia')
## Spatial data processing
library(raster)
library(sf)
```

Now, we can visualize the GIS files that are required in RS Minerve in the following Figure \@ref(fig:GuntGISRSMinerve).

```{r GuntGISRSMinerve, fig.cap = "Gunt river basin overview, showing the digital elevation model, the 4 subcatchments, the elevation bands with 1'000 meters intervals, the main tributary rivers and the corresponding junctions.", message=FALSE, warning=FALSE}
# Load data
fPath <- './data/AmuDarya/Gunt'
gunt_DEM <- raster(paste0(fPath,'/GeospatialData/17050_Gund_Basin_DEM.tif'))
gunt_elBands_shp_utm <- st_read(paste0(fPath,'/GeospatialData/Gunt_ElevationBands_Subbasins_RSMinerve.shp'),quiet=TRUE)
gunt_subbasins_shp_utm <- st_read(paste0(fPath,'/GeospatialData/Gunt_Subbasins_RSMinerve.shp'),quiet=TRUE)
gunt_subbasin_junctions_shp_utm <- st_read(paste0(fPath,'/GeospatialData/Gunt_Junctions_RSMinerve.shp'),quiet=TRUE)
gunt_rivers_shp_utm <- st_read(paste0(fPath,'/GeospatialData/Gunt_Rivers_RSMinerve.shp'),quiet=TRUE)

# Downsample DEM and create hillshade
gunt_DEM_lr <- raster::aggregate(gunt_DEM,fact=10) # this is in UTM 42N
gunt_slope <- terrain(gunt_DEM_lr, opt='slope')
gunt_aspect <- terrain(gunt_DEM_lr, opt='aspect')
gunt_DEM_hillshade <- hillShade(gunt_slope, gunt_aspect, 40, 270)

# Convert to dataframe for ggplotting
gunt_DEM_spdf <- as(gunt_DEM_lr, "SpatialPixelsDataFrame")
gunt_DEM_df <- as.data.frame(gunt_DEM_spdf)
colnames(gunt_DEM_df) <- c("value", "x", "y")
hillshade_Gunt_spdf <- as(gunt_DEM_hillshade, "SpatialPixelsDataFrame")
hillshade_Gunt_df <- as.data.frame(hillshade_Gunt_spdf)
colnames(hillshade_Gunt_df) <- c("value", "x", "y")

# Used for subbasins naming
subbasins <- # just put everything in a regular dataframe
  tibble(basin=c("Shakhdara","Gunt","Tokusbulak","Alishur"),
         lat   = c(37.4,37.75,37.6,37.65),
         lon   = c(72.0,71.8,72.6,73.25))
subbasins_coord_latlon = SpatialPoints(cbind(subbasins$lon, subbasins$lat), proj4string=CRS("+proj=longlat"))
subbasins_coord_UTM <- spTransform(subbasins_coord_latlon, CRS("+init=epsg:32642")) %>% 
  coordinates() %>% as_tibble() %>% 
  rename(x=coords.x1,y=coords.x2)
subbasins <- bind_cols(subbasins,subbasins_coord_UTM)
# Plotting
ggplot() +
  geom_tile(data=gunt_DEM_df, aes(x=x, y=y, fill=value), alpha=0.8) +
  geom_sf(data=gunt_subbasins_shp_utm,color="black",fill=NA,linetype="11",size=0.25) +
  geom_sf(data=gunt_rivers_shp_utm,color="blue",fill=NA) + 
  geom_sf(data=gunt_elBands_shp_utm,color="black",fill=NA,linetype="11",size=.2) +
  geom_sf(data=gunt_subbasin_junctions_shp_utm,color="red",fill="red") + 
  scale_fill_gradientn(colours = terrain.colors(100)) + 
  xlab("Longitude") + ylab("Latitude") + 
  guides(fill=guide_legend(title="Alt. [masl]")) + 
  ggtitle("Gunt catchment and subbasins") +
  geom_label(data = subbasins,aes(x = x, y = y, label = basin),vjust = 0,hjust = 0)
```

Figure \@ref(fig:GuntGISRSMinerve) shows the four subbasins. After the confluence with Tokusbulak river, Alishur river becomes Gunt river in Junction 1 (called junct_1 in the corresponding shapefile below). The confluence is noted by the corresponding red dot. Further downstream, approximately 5 km before the Gunt-Khorog gauging station (Hydromet Code 17050), indicated by the leftmost outlet point (red dot, called junct_2 in the junct_down attribute field of the shapefile), Shakhdara river feeds into Gunt. The subbasin-specific elevation bands are indicated by dotted lines.

As described in the RS Minerve User Manual in Chapter 5 [@rsminerve_um], the following three shapefiles need to be prepared for later loading into RS Minerve: subbasins.shp, junctions.shp and rivers.shp (see Figure \@ref(fig:requiredGISInputFiles)).

```{r requiredGISInputFiles,echo = FALSE, fig.cap = 'Required GIS input files for RS Minerve. See corresponding user manual for more information.'}
knitr::include_graphics('_bookdown_files/FIG_RS_MINERVE/required_GIS_Input_Files.png')
```

The shapefile attributes that you downloaded of the required data can easily be displayed. First, we analyze the subbasins \`gunt_elBands_shp_utm\` file. The file contains the following attributes as per the requirements specified in Figure \@ref(fig:requiredGISInputFiles): name and junct_down. The attributes Z, ModelGuid and *geometry* are additional fields. The field *Z* that contains information of the mean elevation of the subbasin. Note that the shapefile is does not only contain the shape of the four subbasins Alishu, Tokusbulak, Gunt and Shakdara but also the elevation bands of each subbasin.

```{r}
# view meta data summary of the subbasins file
gunt_elBands_shp_utm <- sf::st_read(paste0(fPath,'/GeospatialData/Gunt_ElevationBands_Subbasins_RSMinerve.shp'),quiet=TRUE)
gunt_elBands_shp_utm
```

This is because in RS Minerve, we will model each elevation zone of each subbasin with a separate rainfall-runoff model. These are then linked to each other via the topological ordering that is given by the rivers and junctions. The naming of the subbasins is somewhat arbitrary and tailored to the particular catchment under consideration. The prefix 'basin\_' is everywhere the same. The basic idea is to identify a main river stem (denoted with mX) where the X is a number that increases from 1 towards the downstream after each confluence with a right or left tributary. In our case, Alishur river is denoted with m1. Gunt river, which emerges after the confluence with Tokusbulak (see Figure \@ref(fig:GuntGISRSMinerve)), is denoted with m2. Finally, Gunt river after the confluence with Shakhdara is m3. Each left tributary is denoted with lX and each right tributary with rX, where X is again a number starting from 1 and gradually increasing. In our case, Tokusbulak thus is l1 (the first left tributary joining the main river). Finally, Shakhdara is l2. Note, in the Gunt river basin, we do not have major right tributaries.

'm1_b2' the refers to the main upstream river, Alishur in this case, and its elevation band 2. m1_b3 would then be the third elevation band accordingly and so on. Why is there no m1_b1 feature? This is simple to understand. Since the entire basin is subdivided into n equally spaced elevation zones, the higher lying subbasins might no longer contain all elevation bands. For both, Alishur (main m1) and Tokusbulak (l1) this is the case where band b1 is simply not represented because of the high elevations of the subbasins.

```{r}
#  view meta data summary of the junctions file
gunt_subbasin_junctions_shp_utm <- sf::st_read(paste0(fPath,'/GeospatialData/Gunt_Junctions_RSMinerve.shp'),quiet=TRUE)
gunt_subbasin_junctions_shp_utm
```

```{r,echo=FALSE}
# this is just to correct the shapefile and store it. the block can be deleted later.
# gunt_subbasin_junctions_shp_utm_corr <- gunt_subbasin_junctions_shp_utm %>% dplyr::select(-ModelGuid)
# gunt_subbasin_junctions_shp_utm_corr$name[1] <- 'junct_2'
# gunt_subbasin_junctions_shp_utm_corr$name[2] <- 'junct_3'
# gunt_subbasin_junctions_shp_utm_corr$name[3] <- 'junct_1'
# gunt_subbasin_junctions_shp_utm_corr$river_down[1] <- 'gunt_ds'
# gunt_subbasin_junctions_shp_utm_corr$river_down[3] <- 'gunt_us'
# gunt_subbasin_junctions_shp_utm_corr
# sf::st_write(gunt_subbasin_junctions_shp_utm_corr,paste0(fPath,'/GIS/Gunt_Junctions_RSMinerve.shp'),append=FALSE)
```

For the junctions shapefile, we define their names as well the field river_down, i.e. the name of the river downstream of the junction. Finally, for the rivers shapefile, we define the rivers name and the downstream junction junct_down. The terminal junction corresponds to the outlet of the model. It can be easily seen that junct_3 is the outlet since there is no more downstream river, i.e. \<NA\>.

```{r}
# view meta data summary of the rivers file
gunt_rivers_shp_utm <- st_read(paste0(fPath,'/GeospatialData/Gunt_Rivers_RSMinerve.shp'),quiet=TRUE)
gunt_rivers_shp_utm
```

```{r,echo=FALSE}
# this is just to correct the shapefile and store it. the block can be deleted later.
# gunt_rivers_shp_utm_cor <- gunt_rivers_shp_utm %>% dplyr::select(-ModelGuid)
# gunt_rivers_shp_utm_cor$name[1] <- 'shakhdara'
# gunt_rivers_shp_utm_cor$name[2] <- 'gunt_ds'
# gunt_rivers_shp_utm_cor$name[3] <- 'tokusbulak'
# gunt_rivers_shp_utm_cor$name[4] <- 'alishur'
# gunt_rivers_shp_utm_cor$name[5] <- 'gunt_us'
# gunt_rivers_shp_utm_cor
# sf::st_write(gunt_rivers_shp_utm_cor,paste0(fPath,'/GIS/Gunt_Rivers_RSMinerve.shp'),append=FALSE)
```

### Loading GIS Data and Model Creation

As described in the RSMinerve user manual in Chapter 5 there, these three shapefiles can then be loaded into RSMinerve and automatically translated into an RSMinerve model via the `Creation` option [@rsminerve_um]. In Figure \@ref(fig:RSMinerveGuntModelCreation), a screen shot is shown where in a somewhat arbitrary manner, all subbasins got assigned individual HBV models. Note the highlighted `Creation` button.

```{r RSMinerveGuntModelCreation,echo = FALSE,fig.cap = 'Using the `Creation` Menu, the information from the shapefiles gets translated into a number of interlinked subcatchment and elevation band-specific models.'}
knitr::include_graphics('_bookdown_files/FIG_RS_MINERVE/rsminerveGuntModelCreation')
```

Since the shapefile containing the elevation bands for each subbasin also contains mean subbasin elevation, we can extract the Altitude (Z) from the corresponding feature. Similarly, the area of the subbasins and the length of the rivers can all be computed from the shapefiles. The corresponding boxes should be ticked.

After these steps, the student can click the `Create Model` button in the lower left corner of the window and then switch to the `Model New` tab to examine the resulting model. A screen shot showing the results is shown in Figure \@ref(fig:RSMinerveGuntModelCreationResult).

```{r RSMinerveGuntModelCreationResult,echo = FALSE,fig.cap = 'The result of the GIS-based creation of the Gunt river basin model in RSMinerve. Note that even without proper arrangement of the individual model elements, the subbasins and their models are already visible.'}
knitr::include_graphics('_bookdown_files/FIG_RS_MINERVE/rsminerveGuntModelCreationResult')
```

After rearranging the individual model elements and loading a background .jpeg-image (see Figure \@ref(fig:rsminerveModelPreview), the setup step has been completed.

### Climate Data

RSMinerve simulates discharge in response to climate forcing.




## The HBV model {#section-hbv-model}
The HBV (Hydrologiska Byråns Vattenavdelning) model is a conceptual rainfall-runoff model which is suitable for many snow-fed river catchments [@bergstrom_development_1976; @lindstrom_development_1997]. You have studied the short description of the HBV model in the RS Minerve technical manual [@rsminerve_tm]. Keep these 4 pages at hand for the following exercises so you can look up how the parameters influence the flow of water through the HBV model. A brief reminder of the HBV model implemented in RS Minerve is given in Figure \@ref(fig:fig-overview-hbv-model). The model consists of a snow function which separates precipitation into solid and liquid parts and manages melting of snow and 3 storage reservoirs similar to the linear reservoir we saw in the [recap section](#section-rsminerve-why-model-introduction).      

```{r fig-overview-hbv-model, echo=FALSE, out.width="55%", fig.align="center", fig.cap="The HBV model concept (source: RS MINERVE Technical Manual)."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_HBVconceptualModel.png")
```

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.3"> 
<h3 class = "right">T4.3</h3> 
<h3 class= "left">Model understanding - Drivers</h3> 
<p>Discuss with your colleague(s): What are the model drivers (i.e. what input data do you need to provide)? </p>
<p>Hint: Study the figure above.</p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-hbv-driving-forces">Solution</a></p>
</div>')
```

Figure \@ref(fig:fig-overview-hbv-model-parameters) from the RS Minerve technical manual [rsminerve-tm] gives an overview over the model parameters and states. 
```{r fig-overview-hbv-model-parameters, echo=FALSE, out.width="60%", fig.align="center", fig.cap="The HBV model parameters (source: RS MINERVE Technical Manual)."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_PARandIC.png")
```

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.4"> 
<h3 class = "right">T4.4</h3> 
<h3 class= "left">Model understanding - States</h3> 
<p>Discuss with your colleague(s): What are the model states (i.e. what variables describe the amount of water in the system over time)? </p>
<p>Hint: Values for initial water content in the different model compartments need to be defined prior to the simulation.</p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-hbv-parameters-states">Solution</a></p>
</div>')
```


### HBV example: Simple model of the Nauvalisoy river catchment {#section-hbv-nauvalisoy-tutorial-short}
#### Set up the model {#section-hbv-nauvalisoy-modelling-setup}  

1. Open RS Minerve and create an HBV model with the correct area ([Step-by-step guide](#section-quickguides-create-hbv-model)).  
2.  Add a climate station and link it to the HBV model ([Step-by-step guide](#section-quickguides-add-climate-station)) .   
3.  Climate data has been prepared in the file ./data/SyrDarya/Chirchiq/RSMinerve/ERA5_Nauvalisoy_1981_2013.csv. Import the data in RS Minerve and link it to the station data ([Step-by-step guide](#section-quickguides-import-climate-data)).  
4.  Change the model settings to calculate evaporation using Turc and adapt the coordinates in the settings tab [Step-by-step guide](#section-quickguides-atapt-model-settings).   

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.5"> 
<h3 class = "right">T4.5</h3> 
<h3 class= "left">RS Minerve - Data visualization</h3> 
<p>Use the Selection and plots tool in the Modules toolbar of RS Minerve and display the hourly model inputs precipitation and temperature for the example year 1984. What is the approximate temperature range over the year? What is the annual precipitation? </p>
<p>Hint: Adapt the simulation period in the model tab accordingly. Do not forget to set the initial conditions of the model to the last hour of 1983.</p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-plot-temperature-and-precipitation-1984">Solution</a></p>
</div>')
```

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.6"> 
<h3 class = "right">T4.6</h3> 
<h3 class= "left">RS Minerve - Compare evaporation models</h3> 
<p>Compare the different methods to calculate hourly evaporation in 1984 and their impact on the simulated discharge. Is the uniform evaporation model suitable for seasonal discharge models? In what circumstance could a uniform evaporation model be appropriate?  </p>
<p>Hint: Export simulation results to the data base (<a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-quick-guides-export-sim-results-to-db>how to).</p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-compare-evaporation-methods">Solution</a></p>
</div>')
```






## Model Calibration and Validation {#section-model-calibration-and-validation}

### Basic Principles {#section-calibration-principles}
The large number of parameters of the HBV model can be adjusted within reasonable ranges to make the simulated river discharge more similar to the measured discharge. This process is sometimes called history matching because past measurements are used to adapt the model parameters. The following two exercises are important for understanding hydrological models. They are relevant whether you work as a modeler or as a decision maker. Try to first come up with a few own ideas and then study the solutions carefully. They will be discussed in the lectures in more detail.    

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.7"> 
<h3 class = "right">T4.7</h3> 
<h3 class= "left">Model calibration - Common difficulties</h3> 
<p>Discuss with your colleague(s): What are typical difficulties inherent to the calibration of common semi-distributed (or fully distributed) hydrological models?</p>
<p>Hint: Compare the number of parameters of the HBV model to the number of model states.</p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-common-calibration-issues">Solution</a></p>
</div>')
```

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.8"> 
<h3 class = "right">T4.8</h3> 
<h3 class= "left">Model calibration - Strategies to handle the difficulties</h3> 
<p>Discuss with your colleague(s): Based on the list of common difficulties in the solution of exercise 5, think about possible strategies to address these challenges.</p>
<p>Hint: A modeler proverb says "as simple as possible but as complex as necessary".</p>
<p><a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-strategies-for-issues">Solution</a></p>
</div>')
```




#### Calibration vs. validation  
As you have learned, semi- and fully distributed hydrological models are typically not well defined, i.e. you will find multiple sets of parameter combinations which will all yield reasonable model performance. An important strategy to gain confidence into a model is to split your time series into a calibration period and a validation period. During calibration, you adjust the model parameters to get a satisfying fit with the measured discharge. During the validation period you check how the calibrated model compares to discharge data that it hasn't seen before, i.e. you judge the ability of the model to handle potentially different model input than it has seen during calibration. For example, if you have 30 years of discharge time series available you can use the first 10 years for model calibration (i.e. you run the model calibration procedure only over the first 10 years of the time series) and use the last 20 years for model validation. A good model should perform satisfactorily not only during calibration but also during validation.   
In hydrology, it is recommended to do cross-validation, i.e. to calibrate and validate a model with several combinations of calibration and validation periods and to summarize the overall model performance.   
Interested readers are refered to the literature for a more thorough discussion of the topic. For example, Bergstroem [@bergstrom_principles_1991] gives a thorough discussion of model calibration and validation based on the HBV model which is still valid today.  


#### Performance indicators
Model performance can be expressed in different ways. Some indicators are better suited to calibrate high flows (e.g. root mean squared error) and some are better suited to calibrate low flows (e.g. Nash coefficient for logarithm values). Others evaluate the models ability to reproduce the exceedance of a given discharge which is especially important for flood modelling. The calibration result depends on the choice of the performance indicators. For the automated calibration in RS Minerve, the user can choose a combination of several performance indicators. Care has to be taken to choose them according to the models goal. 

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.9"> 
<h3 class = "right">T4.9</h3> 
<h3 class= "left">Model performance indicators</h3> 
<p>The RS Minerve technical manual summarizes the most important performance indicators typically used in hydrological modelling. For the more ambitious modellers, the manual includes references to the literature.</p>
<p>Read Chapter 3 of the technical manual. </p>
</div>')
```



### Practical Steps {#secion-calibration-practical-steps}
#### Manual calibration of synthetic discharge {#section-hbv-nauvalisoy-calibration}  
The following section describes the steps for manual model calibration. We use the example of the Nauvalisoy river catchment and calibrate it with synthetic discharge measurements to deepen our understanding of the HBV model. For the synthetic discharge measurements it is theoretically possible to find a perfect match between simulated and measured data which is typically not the case for real measurements.    
Add a comparator and a source object to your Nauvalisoy model and load river discharge measurements (filename), then run the model [Here](#section-quickguides-add-comparator-and-discharge-data) is a detailed step-by-step description of how to do this. With default parameters, the outcome of this step should look like Figure \@ref(fig:rsminerve-run-model-precalibration). Should your result differ significantly from the one shown here, compare the parameters of the HBV mode to the ones in the file [./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_precalibration.txt](./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_precalibration.txt). You can import the parameter set to RS Minerve via Import P in the model properties toolbar.

```{r rsminerve-run-model-precalibration, echo=FALSE, out.width="80%", fig.align="center", fig.cap="The simulated discharge (green) differs from the reference discharge (blue) before model calibration."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_simulation_result_before_calibration_synthetic.png")
```

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.10"> 
<h3 class = "right">T4.10</h3> 
<h3 class= "left">RS Minerve - Manual calibration of synthetic discharge</h3> 
<p>1. Try to calibrate the model. Start with the parameters of the snow function and then proceed downwards through the compartments of the HBV model. Try to figure out which parameters influence the timing of the discharge peak, which the height of the peak and which the form of the recession curve.</p>
<p>2. Look at the variables of the HBV model during calibration (e.g. snow water equivalent, soil moisture, etc.).</p>
<p>Hint: This is an iterative process, give yourself some time for this task before you go peaking in the results.</p>
<p>The parameters of the calibrated model are linked <a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-calibrated parameters">here</a>. Inspiration for this exercise from Prof. Jan Seibert and colleagues.</p>
</div>')
```

The calibration process can be automated in RS Minerve. Automated calibration works similarly as manual calibration: A parameter is changed to minimize the calibration performance criteria (e.g. the difference between the simulated and the measured discharge). Because the automated calibration is much faster than manual calibration, it is extremely tempting to let it calibrate all parameters at once while working on something else but by now you know that good modeling is not as simple as that. Let's see if RS Minerve finds the parameter set that was used to produce the synthetic discharge curve. Load the original parameter set via import P in the Model Properties toolbar. The file is in [./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_precalibration.txt](./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_precalibration.txt). Open the calibration tab in the Module toolbar (Figure \@ref(fig:open-calibration-tab)). 
```{r open-calibration-tab, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Open the calibration tab in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_open-calibration-tab.png")
```

In the calibrator tab, select the parameters **CFmax**, **TT**, **TTInt**, **FC**, **SUMax**, **Kr**, **Ku**, **Kl**, and **Kperc** for calibration. Compare the parameter ranges to the calibrated parameter set from the [solutions of the manual calibration example](#section-appendix-solutions-calibrated parameters) and make sure that the *true* parameters are within the range of the parameters to be calibrated (e.g. make sure that for TT and TTInt Max is set to 3 (see also Figure \@ref(fig:calibration-parameters))). 
```{r calibration-parameters, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Open the calibration tab in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_calibration_parameters.png")
```

You will have to choose performance indicators which will be combined in the objective function. 

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.11"> 
<h3 class = "right">T4.11</h3> 
<h3 class= "left">RS Minerve - Automated calibration</h3> 
<p>Choose one or several performance indicators and run the automated calibration. The automated calibration may take a few minutes (expect around 3000 model iterations). Compare the parameters found with the automated calibration to the ones that were used for the generation of the synthetic discharge values (in <a href="https://tobiassiegfried.github.io/HydrologicalModeling_CentralAsia/sectin-appendix-solutions.html#section-appendix-solutions-calibrated parameters">solutions of the manual calibration example</a>). Discuss the differences. Where were you surprised? Which parameters could be identified and which not?</p>
<p>Change the combination and weights of the performance indicators and redo the automated calibration. Note how the calibration result changes. </p>
</div>')
```


You have seen in the exercise above that is not so easy to find the *true* parameter set of a basin. Let's get a better understanding of the model parameters. Choose 1-3 parameters for which you will do a sensitivity analysis. 

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.12"> 
<h3 class = "right">T4.12</h3> 
<h3 class= "left">RS Minerve - Manual sensitivity analysis</h3> 
<p>Discuss with your colleague(s) in which way you expect the model outcomes to change when you modify your chosen parameters before you run the model. </p>
<p>Make notes of the changes in parameters and the changes in the model outcomes.</p>
</div>')
```

The sensitivity analysis can be automated in RS Minerve. Make sure to have the calibrated parameter set loaded (via import P in the Model Properties toolbar). Open the tab for stochastic simulations in the Module toolbar (see Figure \@ref(fig:rsminerve-open-stochastic-simulation)). 

```{r rsminerve-open-stochastic-simulation, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Open the stochastic simulation tab in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_stochasticSimulation.png")
```

Select one of the parameters that you have evaluated manually in the exercise above and assume a uniform distribution between the default parameter ranges for said parameter (see for example Figure \@ref(fig:rsminerve-do-stochastic-simulation)). 
```{r rsminerve-do-stochastic-simulation, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Open the stochastic simulation tab in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_doStochasticSimulation.png")
```

```{r, eval = "html", results='asis', echo=FALSE, purl=FALSE}
cat('
<div class = "task" <div class = "task" id="t4.13"> 
<h3 class = "right">T4.13</h3> 
<h3 class= "left">RS Minerve - Automated sensitivity analysis</h3> 
<p>Perform an automated sensitivity analysis for the same parameters you chose in the previous exercise (manual sensitivity analysis).</p>
<p>Compare the outcome of the manual sensitivity analysis.</p>
<p>Bonus task: Choose a sensitive model parameter and evaluate the sensitivity of the stochastic simulation with regard to the number of simulations or the seed. (The seed is used in the random number generator. It makes the stochastic simulation reproducible.)</p>
</div>')
```


Now we have a rasonable understanding of the HBV model. Let's try it out with real discharge data. Import the database file for Nauvalisoy including measured discharge at the outlet of the catchment [./data/SyrDarya/Chirchiq/RSMinerve/ERA5Q_Nauvalisoy_1981_2013.csv](./data/SyrDarya/Chirchiq/RSMinerve/ERA5Q_Nauvalisoy_1981_2013.csv) into RS Minerve and connect it to your model. Adapt the simulation time period to start on Jan 1 1981 at 1 a.m. until Dec 31 2013 at 11 p.m (the full period with available data). The simulation will take place at the maximum resolution of the forcing data, i.e. at hourly time steps. The discharge measurements are available as averages over 8-11 days. We choose an output interval of 2 days. As the initial water content in the system is not known, a warm-up period of 1 year is typically used to minimize the impact of the unknown initial conditions on the simulation results. You can implement the warm-up period in the comparator object under Parameters. Use the default, pre-calibration parameter set in [./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_precalibration.txt](./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_precalibration.txt) as we don't know much about the catchment properties.  
Figure \@ref(fig:fig-real-discharge-result) shows the resulting discharge time series in the comparator object. 
```{r fig-real-discharge-result, echo=FALSE,message=FALSE,warnin=FALSE, fig.cap="Simulated and measured discahrge at the outlet of the Nauvalisoy catchment."}
knitr::include_graphics("_bookdown_files/FIG_RS_MINERVE/fig_Nauvalisoy_real_discharge_base.png")
```
The simulated discharge peak arrives several months before the observed discharge peak. You may invest 10 minutes to try it out but by merely adjusting the parameters of our HBV model, we will not be able to shift the simulated discharge time series sufficiently to reproduce the measured discharge. We are facing a conceptual model error which we have to identify and eliminate.   

Figure \@ref(fig:gunt-temp-elevation) shows the relationship between elevation and temperature of the 4 meteo stations in the Gunt river catchment. The elevation dependence of temperature is highly important for snow-melt driven river catchments. 

```{r gunt-temp-elevation, message=FALSE,warnin=FALSE, fig.cap="Elevation dependence of mean temperature at the four meteo stations in the Gunt river catchment. The temperature decrease is a little below 1 degree K per 100 m of altitude gain."}
## MeteoStation locations and elevation
meteoStations <- # just put everything in a regular dataframe
  tibble(code = c(38953, 38954, 38956, 38950),
         masl  = c(3746, 2075, 3438, 2566))

# Load Gunt data
data <- read_rds('./data/AmuDarya/Gunt/StationData/gunt_data_cleaned.Rds') %>% 
  dplyr::filter(str_detect(type, "T")) %>%  # Filter for data types that contain T 
  mutate(code = as.numeric(code)) %>%  # Cast code column to numeric
  left_join(meteoStations)  # Add the station altitude to the data

# Plotting the dataframe
data %>%
#   dplyr::filter(!str_detect(type, "meanmax"), 
#                 !str_detect(type, "meanmin")) %>%
  dplyr::filter(str_detect(type, "mean\\(T\\)")) %>%
  dplyr::mutate(Variable = type) %>%
  group_by(code, Variable) %>%
  summarize(norm = mean(norm, na.rm = TRUE), 
            masl = first(masl)) %>%
  ggplot(aes(norm, masl)) +  #, colour = Variable)) + 
  geom_smooth(method = "lm", alpha = 0, colour = "gray") + 
  geom_point() + 
  labs(y = "Altitude [masl]", x = "T [deg C]") + 
  theme_bw()
```

At temperatures below approximately 0 degrees C, precipitation falls as snow and remains stored as snow in the catchment until temperatures above 0 degrees C melt the snow and produce runoff. Especially for snow driven catchments, it is important to take the elevation dependence of temperature into account. In RS Minerve, this can be done by dividing the catchment into several sub-catchments of similar altitude (i.e. elevation bands) and to define temperature (and precipitation) inputs for these sub-catchments. This is a spatial refinement of the model which allows us to better represent the snow storage and melting processes in the catchment. A description of how to obtain the elevation bands is given in the Chapter on the preparation of [geospatial data](#Data::GeospatialData).   


#### Spatial refinement of the model {#section-hbv-elevation-bands}  
** TODO: Nauvalisoy elevation bands at higher resolution, ask tobi how involved the exctraction of the era5 bias corrected data for the elevation bands is **



## Application: Investigating Climate Change Impacts

## Discussion
