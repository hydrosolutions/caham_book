<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="description" content="2024.Q1 Edition hydrosolutions GmbH">
<title>Modeling of Hydrological Systems in Semi-Arid Central Asia - 11&nbsp; Modeling of Discharge from Glacier Melt</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Climate_change_impact_study.html" rel="next">
<link href="./modeling_using_predictive_inference.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./hydrological_modeling.html">Part III: Hydrological Modeling &amp; Applications</a></li><li class="breadcrumb-item"><a href="./glacier_modeling.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modeling of Discharge from Glacier Melt</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Modeling of Hydrological Systems in Semi-Arid Central Asia</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/hydrosolutions/caham_book" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About This Book</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface to the 2024.Q1 Edition</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./study_guide_materials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Study Guide and Materials</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./hydrology_of_central_asia.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part I: Hydrology of Semi-Arid Central Asia</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hydrological_systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Hydrological Systems in Semi-Arid Central Asia</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example_river_basins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Case Study River Basins</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part II: Data Sources, Retrieval and Preparation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Sources of Relevant Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discharge_station_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Discharge Station Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./geospatial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geospatial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./snow_and_glacier_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Snow and Glacier Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./climate_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Climate Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./hydrological_modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part III: Hydrological Modeling &amp; Applications</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hydraulic_hydrological_modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Hydrological-Hydraulic Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./long_term_water_balance_modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Long-term Water Balance Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./modeling_using_predictive_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Modeling Using Predictive Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glacier_modeling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modeling of Discharge from Glacier Melt</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Climate_change_impact_study.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Quantification of Climate Change Impacts</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix_a_free_software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Software</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix_b_riverscentralasia_r_toolbox.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Toolbox riversCentralAsia</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix_c_quick_guides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Quick Guides</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix_d_exercise_solutions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Exercise Solutions</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#glacier-mass-balance" id="toc-glacier-mass-balance" class="nav-link active" data-scroll-target="#glacier-mass-balance"><span class="header-section-number">11.1</span> Glacier Mass Balance</a>
  <ul class="collapse">
<li><a href="#temperature-index-model" id="toc-temperature-index-model" class="nav-link" data-scroll-target="#temperature-index-model"><span class="header-section-number">11.1.1</span> Temperature Index Model</a></li>
  </ul>
</li>
  <li><a href="#glacier-volume-development" id="toc-glacier-volume-development" class="nav-link" data-scroll-target="#glacier-volume-development"><span class="header-section-number">11.2</span> Glacier Volume Development</a></li>
  <li><a href="#glacier-area-volume-scaling" id="toc-glacier-area-volume-scaling" class="nav-link" data-scroll-target="#glacier-area-volume-scaling"><span class="header-section-number">11.3</span> Area-volume scaling</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">11.4</span> References</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/hydrosolutions/caham_book/edit/master/glacier_modeling.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./hydrological_modeling.html">Part III: Hydrological Modeling &amp; Applications</a></li><li class="breadcrumb-item"><a href="./glacier_modeling.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modeling of Discharge from Glacier Melt</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-glacier-modeling" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modeling of Discharge from Glacier Melt</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>The glacier melt modeling in RSMinerve <span class="citation" data-cites="rsminerve_tm">(<a href="#ref-rsminerve_tm" role="doc-biblioref">Garcia Hernandez et al. 2020</a>)</span> is done (at the time of writing, March 2022) with the GSM model which features a constant area and an unlimited glacier reservoir. It is suitable for short-term simulations of glacier melt where effects of glacier volume change can be neglected but it is not well suited for climate change impact studies where substantial changes in glacier volume are to be expected. However, by assuming that discharge from snow melt can be treated independently from discharge from glacier melt, the discharge contribution from glacier melt can be simulated in R and included as source into RSMinerve models. The following chapter relies on the basic understanding of the glacier mass balance as presented and discussed in <a href="@sec-snow-and-glacier-data">Chapter Snow and Glacier Data</a>, describes the glacier modelling tools in the package <code>riversCentralAsia</code> and demonstrates how to use them for joint applied hydrological modelling with RSMinerve.</p>
<section id="glacier-mass-balance" class="level2" data-number="11.1"><h2 data-number="11.1" class="anchored" data-anchor-id="glacier-mass-balance">
<span class="header-section-number">11.1</span> Glacier Mass Balance</h2>
<p>We shift the focus from the catchment to one single glacier within the catchment. Instead of calculating the water balance over the river catchment, we calculate the balance over the glacier.</p>
<div id="fig-glacier-model-zoom-in" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-glacier-model-zoom-in-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/hydrological_modeling/glacier_modeling_zoom_in_elevation_bands.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-glacier-model-zoom-in-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.1: Simplified illustration of a glacierized river basin with elevation bands in dashed lines. The zoom is on one of the larger glaciers which can itself be discretized into elevation bands. The glacier mass loss is substracted from the lower most elevation band in increasing elevation.
</figcaption></figure>
</div>
<p>The glacier mass balance is given in <a href="#eq-general-glacier-mass-balance" class="quarto-xref">Equation&nbsp;<span>11.1</span></a>.</p>
<p><span id="eq-general-glacier-mass-balance"><span class="math display">\[
\Delta S = \text{ablation} + \text{accumulation}
\tag{11.1}\]</span></span> where <span class="math inline">\(\text{ablation}\)</span> denotes the ablation of glacier mass, i.e.&nbsp;glacier mass loss, and <span class="math inline">\(\text{accumulation}\)</span> is the accumulation of glacier mass, i.e.&nbsp;glacier mass growth. Glacier ablation can be modeled using a temperature index model (described in the next section). Note that the ablation term is a negative number.<br>
Many processes contribute to glacier ablation and accumulation, e.g. <span class="citation" data-cites="cogley_glossary_2011">Benn and Evans (<a href="#ref-benn_glaciers_2010" role="doc-biblioref">2010</a>)</span>. The most dominant accumulation processes in high mountain areas are snow fall, avalanches and wind-blown snow. In high mountain regions, glacier ablation is driven by the energy balance at the glacier-air interface <span class="citation" data-cites="hock_glacier_2005">(<a href="#ref-hock_glacier_2005" role="doc-biblioref">Hock 2005</a>)</span>. For most regional hydrological modeling tasks, is is sufficient to simplify the glacier mass balance to <a href="#eq-simplified-glacier-mass-balance" class="quarto-xref">Equation&nbsp;<span>11.2</span></a>. A glacier that is in balance will melt the equivalent of the long-term average precipitation during the warm summer months, called balance ablation <span class="citation" data-cites="pritchard_asias_2019">(<a href="#ref-pritchard_asias_2019" role="doc-biblioref">Pritchard 2019</a>)</span>.</p>
<p><span id="eq-simplified-glacier-mass-balance"><span class="math display">\[
\Delta S = P-\text{Melt} \approx Q_{\text{Gl,imbal}}
\tag{11.2}\]</span></span></p>
<p>where the change of water storage (<span class="math inline">\(\Delta S\)</span>) is equal to the precipitation (<span class="math inline">\(P\)</span>) minus the glacier melt (<span class="math inline">\(\text{Melt}\)</span>). Since temperatures are increasing globally melt typically exceeds precipitation and we have negative <span class="math inline">\(\Delta S\)</span>, that is imbalance ablation <span class="math inline">\(Q_{\text{Gl,imbal}}\)</span>, indicating glacier storage loss. The glacier mass balance is calculated in annual time steps. We thereby refer to the hydrological year starting on October 1st of the previous year to take a full accumulation and ablation season into account.</p>
<section id="temperature-index-model" class="level3" data-number="11.1.1"><h3 data-number="11.1.1" class="anchored" data-anchor-id="temperature-index-model">
<span class="header-section-number">11.1.1</span> Temperature Index Model</h3>
<p>One of the arguably simplest models to describe glacier melt (or snow melt) is the temperature index model. <span class="citation" data-cites="hock_temperature_2003">Hock (<a href="#ref-hock_temperature_2003" role="doc-biblioref">2003</a>)</span> describes several variants of the temperature index model for simulating glacier melt. The <code>riversCentralAsia</code> package implements the simplest temperature index melt model described in <span class="citation" data-cites="hock_temperature_2003">(<a href="#ref-hock_temperature_2003" role="doc-biblioref">Hock 2003</a>)</span> in the function <code>glacierMelt_TI</code> (<a href="#eq-temperature-index-model" class="quarto-xref">Equation&nbsp;<span>11.3</span></a>), requiring only temperature time series and 2 parameters as input.</p>
<p><span id="eq-temperature-index-model"><span class="math display">\[
M = \biggl\{ \begin{array}{l, l}
0, &amp; T &lt; T_{threshold} \\
f_{M} \cdot \left( T - T_{threshold} \right), &amp; T &gt;= T_{threshold}
\end{array}
\tag{11.3}\]</span></span></p>
<p>where <span class="math inline">\(M\)</span> is the glacier melt in <span class="math inline">\(mm/d\)</span>, <span class="math inline">\(T\)</span> is the daily average temperature in <span class="math inline">\(^{\circ} C\)</span>. The two parameters <span class="math inline">\(f_{M}\)</span> and <span class="math inline">\(T_{\text{threshold}}\)</span> refer to the melt factor and the threshold temperature above which glacier melt occurs and need to be calibrated. They have the units <span class="math inline">\(\frac{mm}{^{\circ} C \cdot d}\)</span> and <span class="math inline">\(^{\circ} C\)</span> respectively. Glacier melt is calculated in daily time steps.</p>
</section></section><section id="glacier-volume-development" class="level2" data-number="11.2"><h2 data-number="11.2" class="anchored" data-anchor-id="glacier-volume-development">
<span class="header-section-number">11.2</span> Glacier Volume Development</h2>
<p>As glaciers melt, their volume changes. This has to be taken into account for the long-term simulation of glacier discharge. To determine the initial glacier volume, the area of the geometry of the Randolph Glacier Inventory (RGI) v6.0 data set is multiplied with the average thickness of the glacier (the Farinotti data set). From the combination of these two data sets, the well established area-volume relationship by <span class="citation" data-cites="erasov_1968">Erasov (<a href="#ref-erasov_1968" role="doc-biblioref">1968</a>)</span> can be verified (see section on <a href="#glacier-area-volume-scaling">Area-Volume scaling</a>). Please note that the data and the retrieval of the data are described in <a href="@sec-data">Part II</a> of this book.</p>
<!-- Glaciers larger than 1km^2^ are sub-divided into elevation bands of 100 m altitude to account for elevation dependent temperature forcing. The total glacier volume is distributed to the elevation bands proportionally to their size.  -->
<!-- $$ -->
<!-- V_{\text{elBands}} = V_{tot} \cdot \frac{A_{\text{elBands}}}{A_{tot}} -->
<!-- $$ -->
<!-- The glacier mass loss has to be distributed over the glacier. A commonly used method is the Huss- or $\delta h$-parameterization [@huss_future_2010] who employ a non-linear empirical function. As data for calibration of this function is not available to us we decided to attribute glacier melt to elevation bands. The large glaciers melt from the lowest elevation band to the highest elevation band whereby the glacier melt is subtracted from the glacier volume of lowest elevation band that is still glacierized. The small glaciers are not spatially discretized and thus they are melted homogeneously. -->
<!-- For annual time step $t$, the evolution of the glacier volume is calculated as follows: -->
<!-- $$ -->
<!-- A(t) = \text{glacierArea RGIF}\bigl(V(t)\bigr) -->
<!-- $$ {#eq-step-wise-glacier-mass-balance-glacier-area-rgif} -->
<!-- $$ -->
<!-- Q_{glacier}(t) = M(t) \cdot A(t) -->
<!-- $$ {#eq-step-wise-glacier-mass-balance-glacier-discharge} -->
<!-- $$ -->
<!-- V(t+1) = V(t) + \Delta S = V(t) + \text{glacierImbalAbl}\bigl(M(t)\bigr)  -->
<!-- $$ {#eq-step-wise-glacier-mass-balance-volume-update} -->
<!-- $Q_{\text{glacier}}$ can be calibrated against glacier discharge derived from the Miles & Hugonnet data sets. The automated calibration is currently not included in the `riversCentralAsia` package. -->
<!-- The function `glacierArea_RGIF()` is an empirical scaling function analogue the inverse of the scaling function derived by @erasov_1968 but based on the modern RGI v6.0 glacier geometries and the glacier thickness data set by @farinotti_consensus_2019. Section [Area-volume scaling](#glacier-area-volume-scaling) shows the derivation of the scaling relationship and its comparison to the relationship proposed by @erasov_1968. The package `riversCentralAsia` implements volume-area and area-volume scaling functions based on both, Erashov and RGI-Farinotti data, allowing the estimation of glacier areas based on glacier volumes (`glacierArea_Erasov` and `glacierArea_RGIF`) and estimations of glacier volumes based on glacier areas (`glacierVolume_Erasov` and `glacierVolume_RGIF`). -->
<!-- The function `glacierImbalAbl` is an empirical scaling function relating glacier imbalance ablation, i.e. the glacier melt from storage loss. It is derived from the glacier discharge data set by @miles_health_2021 and the glacier thinning data set by @hugonnet_accelerated_2021 (see section on [glacier discharge-thinning scaling](#glacier-discharge-thinning-scaling) for the derivation of the relationship). -->
<!-- ## Summary of Workflow -->
<!-- To model the contribution to discharge from glacier melt in a basin, the following steps are required:  -->
<!-- - Pre-processing of GIS layers   -->
<!-- - Pre-processing of climate forcing data   -->
<!-- - Calculation of daily glacier melt   -->
<!-- - Calculation of annual glacier masss balance   -->
<!-- - Scaling of annual glacier contribution to daily values   -->
<!-- - Aggregation of per glacier contribution to sub-basins (optional) -->
<!-- - Writing of RSMinerve source intput files   -->
<!-- - Integration of glacier discharge sources in RSMinerve    -->
<!-- ## Propagation of Uncertainty -->
<!-- The initial glacier volume of each glacier is attributed an uncertainty of p/m 26%. This number is based on the average uncertainty of the glacier volume per RGI region reported in @farinotti_consensus_2019. The uncertainty of the area of the RGI v6.0 glacier outlines is not known. It is therefore assumed that the error of the glacier volume stems to 50% from the estimation of the glacier thickness and to 50% from the glacier area. We further assume that the errors of the glacier area and glacier thickness are un-correlated and can thus estimate the uncertainties of the glacier area data and the glacier thickness data to be p/m 13% each. -->
<!-- For the non-linear relationships in `glacierVolume_RGIF` and `glacierArea_RGIF`, the standard deviation of the residuals of the fit was computed. The estimated error of the fit is assumed to be equal plus/minus twice the standard deviation of the residuals and yields 31% and 53% respectively. The residuals are not normally distributed and their actual distribution is unknown. Further, uncorrelated errors and the applicability of linear error propagation are assumed. Therefore, the error of the function outputs is simply computed by adding the error of the function input to the error of the fit. -->
<!-- $$ -->
<!-- \varepsilon_{V} = \varepsilon_{A} + \varepsilon_{\text{glacierVolume RGIF}} = 0.26 + 0.31 = 0.57 -->
<!-- $$ {#eq-error-glacier-volume-rgif} -->
<!-- $$ -->
<!-- \varepsilon_{A} = \varepsilon_{V} + \varepsilon_{\text{glacierArea RGIF}} = 0.26 + 0.53 = 0.79 -->
<!-- $$ {#eq-error-glacier-area-rgif} -->
<!-- Error estimates for the temperature index model are not available. A conservative relative error of 2 is therefore assumed, indicating that the estimated glacier melt is within a range of plus/minus 2 times it's value. -->
<!-- The error of the imbalance ablation amounts to 73%. Assuming independent errors from the temperature index model for glacier melt and the scaling function between imbalance ablation and glacier melt, the error of the imbalance ablation amounts to approximately: -->
<!-- $$ -->
<!-- \varepsilon_{Q_{\text{imb,melt}}} = \varepsilon_{Q_{\text{M}}} + \varepsilon_{\text{glacierImbalAbl}} = 2 + 0.73 = 2.73 -->
<!-- $$ {#eq-error-imbalance-ablation} -->
<!-- The errors stated above relate to initial estimates of the glacier areas, volumes, total ablation and imbalance ablation. The errors of the glacier model variables of each subsequent time step depend on the errors of the previous time steps, i.e. they are not uncorrelated over time. For simplicity reason, this non-linear propagation of errors is neglected. In any case, the uncertainty margins for any glacier melt modelling done with the presented method are large. The following table summarises the estimated errors for each variable -->
<!-- ```{r} -->
<!-- # Relative error estimates for the initial state in % -->
<!-- error_stats = tibble::tibble( -->
<!--   sV = 0.26,  # Glacier volume -->
<!--   sA = 0.13,  # Glacier area -->
<!--   sTh = 0.13,  # Glacier thickness -->
<!--   sMelt = 2)  # Glacier melt  -->
<!-- ``` -->
</section><section id="glacier-area-volume-scaling" class="level2" data-number="11.3"><h2 data-number="11.3" class="anchored" data-anchor-id="glacier-area-volume-scaling">
<span class="header-section-number">11.3</span> Area-volume scaling</h2>
<p>The best known scaling relationships for Central Asian glaciers is the Erasov scaling function (<a href="#eq-erasov" class="quarto-xref">Equation&nbsp;<span>11.4</span></a>).</p>
<p><span id="eq-erasov"><span class="math display">\[
V_{\text{Erasov}} = 0.027 \cdot A^{1.5}
\tag{11.4}\]</span></span></p>
<p>Where <span class="math inline">\(A\)</span> is the glacier area in <span class="math inline">\(km^2\)</span> and <span class="math inline">\(V_{\text{Erasov}}\)</span> is the glacier volume in <span class="math inline">\(km^3\)</span>.</p>
<p>The following code snippet shows how the area volume relationship is re-fitted using the glacier outlines from RGI v6.0 and the glacier thickness data set by <span class="citation" data-cites="farinotti_consensus_2019">Farinotti et al. (<a href="#ref-farinotti_consensus_2019" role="doc-biblioref">2019</a>)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Loading the necessary libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.4.4     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ tidyr::extract() masks raster::extract()
✖ dplyr::filter()  masks stats::filter()
✖ dplyr::lag()     masks stats::lag()
✖ dplyr::select()  masks raster::select()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'gridExtra'

The following object is masked from 'package:dplyr':

    combine</code></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/">broom</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"hydrosolutions/riversCentralAsia"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://hydrosolutions.github.io/riversCentralAsia/index.html">riversCentralAsia</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Load the RGIv6.0 data set of the RGI region of Central Asia</span></span>
<span><span class="va">rgi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"../caham_data/central_asia_domain/glaciers/RGIv60/13_rgi60_CentralAsia.shp"</span>, </span>
<span>               quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">rgi</span> <span class="op">&lt;-</span> <span class="va">rgi</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RGIId</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Area_m2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">rgi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#  To extract the data for the entire Central Asian </span></span>
<span><span class="co"># region takes a several hours on a recent personal computer. </span></span>
<span><span class="co"># Get a list of the glacier thickness maps from Farinotti and Huss</span></span>
<span><span class="va">glacier_thickness_dir</span> <span class="op">&lt;-</span> <span class="st">"&lt;local_path_to_adapt&gt;/FARINOTTI_Glacier_Thickness/composite_thickness_RGI60-13/RGI60-13/"</span></span>
<span><span class="va">filelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">glacier_thickness_dir</span>, pattern <span class="op">=</span> <span class="st">".tif$"</span>, </span>
<span>                       full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Filter the glacier thickness file list for the glacier ids in the RGI data set </span></span>
<span><span class="co"># (if a subset is to be analysed). </span></span>
<span><span class="co">#filelist &lt;- filelist[sapply(rgi$RGIId, grep, filelist)]</span></span>
<span></span>
<span><span class="co"># Get the mean glacier thickness for each of the glaciers in filelist. </span></span>
<span><span class="va">glacier_thickness</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">glacier</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">filelist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rgiid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">filelist</span><span class="op">[</span><span class="va">glacier</span><span class="op">]</span>, <span class="st">"RGI60-13.\\d{5}"</span><span class="op">)</span></span>
<span>  <span class="va">rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">filelist</span><span class="op">[</span><span class="va">glacier</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">exact_extract</span><span class="op">(</span><span class="va">rast</span>, </span>
<span>                        <span class="va">rgi</span><span class="op">$</span><span class="va">geometry</span><span class="op">[</span><span class="va">rgi</span><span class="op">$</span><span class="va">RGIId</span> <span class="op">==</span> <span class="va">rgiid</span><span class="op">]</span>, </span>
<span>                        fun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"weighted_mean"</span>, <span class="st">"weighted_sum"</span><span class="op">)</span>, </span>
<span>                        weights <span class="op">=</span> <span class="st">"area"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>RGIId <span class="op">=</span> <span class="va">rgiid</span><span class="op">)</span></span>
<span>  <span class="va">glacier_thickness</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">glacier_thickness</span>, <span class="va">temp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">glacier_thickness</span> <span class="op">&lt;-</span> <span class="va">glacier_thickness</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Vice_s_m3 <span class="op">=</span> <span class="va">weighted_sum</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">glacier_thickness</span>, </span>
<span>     file <span class="op">=</span> <span class="st">"../caham_data/central_asia_domain/glaciers/Farinotti/glacier_thickness_extractedRGIreg13.RData"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load the average glacier thickness per glacier</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"../caham_data/central_asia_domain/glaciers/Farinotti/glacier_thickness_extractedRGIreg13.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rgi</span> <span class="op">&lt;-</span> <span class="va">rgi</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">glacier_thickness</span> <span class="op">|&gt;</span> </span>
<span>              <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RGIId</span>, <span class="va">weighted_mean</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"RGIId"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>thickness_m <span class="op">=</span> <span class="va">weighted_mean</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Volume_m3 <span class="op">=</span> <span class="va">Area_m2</span> <span class="op">*</span> <span class="va">thickness_m</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare the data for curve fitting. Exclude Fedchenko glacier as it is </span></span>
<span><span class="co"># so much larger than all other glaciers in RGI region 13.   </span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">rgi</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RGIId</span>, <span class="va">Area_m2</span>, <span class="va">thickness_m</span>, <span class="va">Volume_m3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Area_km2 <span class="op">=</span> <span class="va">Area_m2</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">6</span><span class="op">)</span>, </span>
<span>         Volume_km3 <span class="op">=</span> <span class="va">Volume_m3</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Area_km2</span> <span class="op">&lt;</span> <span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Fit a model of similar shape as Erasovs area-volume relationship. </span></span>
<span><span class="co"># V = 0.027 * A ^1.5</span></span>
<span><span class="co"># Note: We use the inverse of the glacier area to weight the fitting to not </span></span>
<span><span class="co"># favor glaciers with large areas in the fit.   </span></span>
<span><span class="va">nlVAw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">Volume_km3</span> <span class="op">~</span> <span class="va">a</span> <span class="op">*</span> <span class="va">Area_km2</span><span class="op">^</span><span class="va">b</span>, </span>
<span>             data <span class="op">=</span> <span class="va">data</span>, </span>
<span>             weights <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">data</span><span class="op">$</span><span class="va">Area_km2</span>,  <span class="co">#  </span></span>
<span>             start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0.05</span>, b <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the modeled volume to the "observed" volume. </span></span>
<span><span class="va">data_nlVAw</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.fitted <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html">augment</a></span><span class="op">(</span><span class="va">nlVAw</span><span class="op">)</span><span class="op">$</span><span class="va">.fitted</span>, </span>
<span>         Volume_RGIF_km3 <span class="op">=</span> <span class="va">.fitted</span>, </span>
<span>         Volume_Erasov_km3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/riversCentralAsia/man/glacierVolume_Erasov.html">glacierVolume_Erasov</a></span><span class="op">(</span><span class="va">Area_km2</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plotting the results</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data_nlVAw</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Area_km2</span>, <span class="va">Volume_km3</span>, colour <span class="op">=</span> <span class="st">"Obs"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>             alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Area_km2</span>, <span class="va">Volume_Erasov_km3</span>, colour <span class="op">=</span> <span class="st">"Erasov"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>             alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Area_km2</span>, <span class="va">Volume_RGIF_km3</span>, colour <span class="op">=</span> <span class="st">"RGIF"</span><span class="op">)</span>, </span>
<span>             alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Legend"</span>, </span>
<span>                      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Obs"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Erasov"</span> <span class="op">=</span> <span class="st">"green"</span>, </span>
<span>                                 <span class="st">"RGIF"</span> <span class="op">=</span> <span class="st">"forestgreen"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Volume ["</span> <span class="op">*</span> <span class="va">km</span><span class="op">^</span><span class="fl">3</span> <span class="op">*</span> <span class="st">"]"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Area ["</span> <span class="op">*</span> <span class="va">km</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="st">"]"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data_nlVAw</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Area_km2</span>, <span class="va">Volume_km3</span>, colour <span class="op">=</span> <span class="st">"Obs"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>             alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Area_km2</span>, <span class="va">Volume_Erasov_km3</span>, colour <span class="op">=</span> <span class="st">"Erasov"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>             alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Area_km2</span>, <span class="va">Volume_RGIF_km3</span>, colour <span class="op">=</span> <span class="st">"RGIF"</span><span class="op">)</span>, </span>
<span>             alpha <span class="op">=</span> <span class="fl">0.4</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Legend"</span>, </span>
<span>                      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Obs"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Erasov"</span> <span class="op">=</span> <span class="st">"green"</span>, </span>
<span>                                 <span class="st">"RGIF"</span> <span class="op">=</span> <span class="st">"forestgreen"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Volume ["</span> <span class="op">*</span> <span class="va">km</span><span class="op">^</span><span class="fl">3</span> <span class="op">*</span> <span class="st">"]"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Area ["</span> <span class="op">*</span> <span class="va">km</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="st">"]"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-glacier-varea-volume-scaling" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-glacier-varea-volume-scaling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="glacier_modeling_files/figure-html/fig-glacier-varea-volume-scaling-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-glacier-varea-volume-scaling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11.2: Glacier volume and glacier area estimated with different methods.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-glacier-varea-volume-scaling" class="quarto-xref">Figure&nbsp;<span>11.2</span></a> shows the glacier volume estimate with different methods vs.&nbsp;the glacier area. The two functions perform similarly for small glaciers, i.e.&nbsp;Erasov is still valid. For large glaciers the two parameter sets differ. However, the uncertainties of the glacier volume estimates are larger than the difference between the two functions so Erasov can still be considered to be valid also for larger glaciers though we use the RGIF fit here which is based on more and newer data.</p>
<p>Based on the large data set, the empirical glacier area-volume relationship based on the RGI v6.0 glacier outlines and the glacier thickness by <span class="citation" data-cites="farinotti_consensus_2019">Farinotti et al. (<a href="#ref-farinotti_consensus_2019" role="doc-biblioref">2019</a>)</span> may be more suitable for large glaciers in Central Asia.</p>
<p><span id="eq-volume-rgif"><span class="math display">\[
V_{\text{RGIF}}= a \cdot A^{b}
\tag{11.5}\]</span></span></p>
<p>With <span class="math inline">\(A\)</span> being the glacier area in <span class="math inline">\(km^2\)</span>, <span class="math inline">\(V_{\text{RGIF}}\)</span> beging the glacier volume in <span class="math inline">\(km^3\)</span>, and the parameters <span class="math inline">\(a=\)</span> 0.0388 and <span class="math inline">\(b=\)</span> 1.262. The newly fitted scaling relationship is implemented as <code>glacierVolume_RGIF</code> in the package <code>riversCentralAsia</code>, the Erasov scaling relationship is implemented as <code>glacierVolume_Erasov</code>.</p>
<p>The area-volume scaling by Erasov and the area-volume scaling with updated parameters (RGIF) can be reversed. Thereby it is possible to update the glacier area as a function of the glacier volume.</p>
<p><span id="eq-area-erasov"><span class="math display">\[
A = \exp \Bigg( \frac{\log V  - \log a}{b}\Bigg)
\tag{11.6}\]</span></span></p>
<p>where <span class="math inline">\(V\)</span> is the glacier volume in <span class="math inline">\(km^3\)</span> and <span class="math inline">\(A\)</span> is the glacier area in <span class="math inline">\(km^2\)</span>. The parameters <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> are the parameters of the Erasov scaling function or the RGIF scaling function. The equations are implemented in the <code>riversCentralAsia</code> package as <code>glacierArea_Erasov</code> and <code>glacierArea_RGIF</code> respectively.</p>
<!-- ## Glacier discharge-thinning scaling {#glacier-discharge-thinning-scaling} -->
<!-- For hydrological modeling, not only the glacier mass changes but also the seasonal contributions of glacier melt to river discharge is of importance. Annual glacier elevation change rates (like for example the data set by @hugonnet_accelerated_2021) describe (simplified) glacier imbalance ablation. However, glaciers contribute also the balance ablation to river discharge, i.e. the glacier melt which is equivalent to the glacier accumulation.   -->
<!-- The simulation results by @miles_health_2021 yield both balance and imbalance ablation as well as total glacier discharge for thousands of glaciers in High Mountain Asia. By deriving an empirical relationship between the glacier elevation change rates by @hugonnet_accelerated_2021 and total glacier discharge by @miles_health_2021, it is possible to estimate the glacier contribution to river discharge.  -->
<!-- ```{r} -->
<!-- #| fig-cap: "Empirical relationship between glacier mass change rate and total glacier ablation derived from data by Hugonnet et al., 2021 and Miles et al., 2021." -->
<!-- #| label: fig-glacierTotalAblationHM  -->
<!-- # Load long-term glacier thinning rates by Hugonnet et al., 2021 -->
<!-- # dmdtda corresponds to the glacier mass change in m water equivalents per year -->
<!-- hugonnet <- read_csv("../caham_data/central_asia_domain/glaciers/Hugonnet/dh_13_rgi60_pergla_rates.csv")  |>  -->
<!--   tidyr::separate(period, c("start", "end"), sep = "_") |>  -->
<!--   mutate(start = as_date(start, "%Y-%m-%d"),  -->
<!--          end = as_date(end, "%Y-%m-%d"),  -->
<!--          period = round(as.numeric(end - start, units = "days")/366)) |>  -->
<!--   dplyr::filter(period == 20) -->
<!-- # Load glacier ablation data by Miles et al., 2021 and filter to the Central  -->
<!-- # Asian domain -->
<!-- miles <- read_csv("../caham_data/central_asia_domain/glaciers/Miles/Miles2021_Glaciers_summarytable_20210721.csv") |> -->
<!--   dplyr::filter(grepl("RGI60-13.", RGIID),  -->
<!--                 VALID == 1) -->
<!-- # Merge the two data sets by glacier -->
<!-- mhcompare <- left_join(miles, hugonnet, by = c("RGIID" = "rgiid"))  -->
<!-- lm_dmdtdaQ_growth <- lm(formula = totAbl ~ dmdtda,  -->
<!--                           data = mhcompare |> -->
<!--                             dplyr::filter(dmdtda > 0)) -->
<!-- lm_dmdtdaQ_melt <- lm(formula = totAbl ~ dmdtda,  -->
<!--                           data = mhcompare |> -->
<!--                             dplyr::filter(dmdtda <= 0)) -->
<!-- data_lmdmdtdaQ_growth <- mhcompare |>  -->
<!--   dplyr::filter(dmdtda > 0) |>  -->
<!--   mutate(totAbl_growth = broom::augment(lm_dmdtdaQ_growth)$.fitted) -->
<!-- data_lmdmdtdaQ_melt <- mhcompare |>  -->
<!--   dplyr::filter(dmdtda <= 0) |>  -->
<!--   mutate(totAbl_melt = broom::augment(lm_dmdtdaQ_melt)$.fitted) -->
<!-- ggplot() +  -->
<!--   geom_vline(xintercept = 0) +  -->
<!--   geom_point(data = mhcompare, aes(x = dmdtda, y = totAbl), size = 0.2) +  -->
<!--   geom_line(data = data_lmdmdtdaQ_growth |> dplyr::filter(dmdtda <= 0.5),  -->
<!--             aes(x = dmdtda, y = totAbl_growth), colour = "green") +  -->
<!--   geom_line(data = data_lmdmdtdaQ_growth |> dplyr::filter(dmdtda > 0.5),  -->
<!--             aes(x = dmdtda, y = -269787.7), colour = "green", linetype = 2) +  -->
<!--   geom_line(data = data_lmdmdtdaQ_melt |> dplyr::filter(dmdtda >= -1),  -->
<!--             aes(x = dmdtda, y = totAbl_melt), colour = "red") +  -->
<!--   geom_line(data = data_lmdmdtdaQ_melt |> dplyr::filter(dmdtda < -1),  -->
<!--             aes(x = dmdtda, y = -1121811), colour = "red", linetype = 2) +  -->
<!--   labs(x = "Hugonnet glacier mass change [m weq/a]",  -->
<!--        y = "Miles total glacier ablation [m3/a]") +  -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- The function `glacierTotalAblation_HM` of the package `riversCentralAsia` implements the empirical relationship between glacier mass change and total glacier ablation shown in @fig-glacierTotalAblationHM.   -->
<!-- ## Demonstration -->
<!-- We demonstrate the above described method with the data from the Atbashy basin.  -->
<!-- :::{.callout-warning} -->
<!-- All required data is available from [the downloadable data package](https://www.dropbox.com/sh/mfm3lk2av1t74bw/AABw5ER3E3JOqjp-SdWfLol0a?dl=1){target="_blank"}. Note however that this folder requires 12 GB of local storage space if you download it. -->
<!-- ::: -->
<!-- ```{r} -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- library(tmap, quietly = TRUE) -->
<!-- library(sf, quietly = TRUE) -->
<!-- library(raster, quietly = TRUE) -->
<!-- library(exactextractr, quietly = TRUE) -->
<!-- library(tidyverse, quietly = TRUE) -->
<!-- library(lubridate, quietly = TRUE) -->
<!-- devtools::install_github("hydrosolutions/riversCentralAsia", quiet = TRUE) -->
<!-- library(riversCentralAsia, quietly = TRUE) -->
<!-- # Path to the data directory downloaded from the download link provided above.  -->
<!-- # Here the data is extracted to a folder called atbashy_glacier_demo_data -->
<!-- data_path <- "../caham_data/SyrDarya/Atbashy/" -->
<!-- ``` -->
<!-- ### Forcing -->
<!-- There will be a separate Section to demonstrate how to prepare the forcing. For now, we provide you with the pre-processed forcing data and give you just a brief overview over the data source. -->
<!-- #### Historical Temperatures -->
<!-- As meteorological data for high elevations in Central Asia is very scarce we use the CHELSA v2.1 data set [@karger_2017]. This is a global data set of forcing data for hydrolgical models based on ERA5 but corrected for biases and especially suited for high elevations. The daily CHELSA forcing has been cut to the Central Region by the originator of the data set, D. Karger, WSL and extracted to the hydrological response units of the glaciers in the Atbashy basin by T. Siegfried. -->
<!-- ```{r} -->
<!-- #| label: fig-histobs -->
<!-- #| fig-cap: "Daily temperature time series of a small glacier (RGI60-13.08930) in the Atbashy basin. Data source: CHELSA v2.1."  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- hist_obs <- readRDS(file = paste0(data_path, "CLIMATE/hist_obs_glacier_tas.rds")) -->
<!-- # Plot the temperature time series for a given glacier/elevation band -->
<!-- glacier <- "RGI60-13.08930_1" -->
<!-- ggplot(hist_obs) +  -->
<!--   geom_line(aes(date, get(glacier))) +  -->
<!--   labs(x = "Date", y = "T [deg C]") + -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- #### Future Temperatures -->
<!-- Future temperature development per glacier or elevation band is extracted from the 3 CMIP6 GCM models with highest priorities for the region downloaded from COPERNICUS. We take 4 socioeconomic scenarios into account, covering 4 different emission scenarios. The temperatures of the climate models are bias corrected using the CHELSA data and a quantile mapping method. More details in the climate data preparation section.  -->
<!-- ```{r} -->
<!-- #| label: fig-futsim -->
<!-- #| fig-cap: "Annual historical (CHELSA) and future (CMIP6, Copernicus) temperature for glacier RGI60-13.08930. "  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- fut_sim <- readRDS(file = paste0(data_path, "CLIMATE/fut_sim_glacier_tas_qmapped.RDS")) -->
<!-- # Plot the temperature time series for a given glacier/elevation band -->
<!-- glacier <- "RGI60-13.08930_1" -->
<!-- # Extract the temperature for the selected glaciers for all GCMs and SSPs -->
<!-- scenarios <- names(fut_sim) -->
<!-- fut_temp <- NULL -->
<!-- for (scenario in scenarios) { -->
<!--   fut_temp <- rbind(fut_temp,  -->
<!--                     fut_sim[[scenario]] |>  -->
<!--                       dplyr::select(Date, all_of(glacier)) |>  -->
<!--                       mutate(Scenario = scenario)) -->
<!-- } -->
<!-- fut_temp <- fut_temp |>  -->
<!--   mutate(Hyear = hyear(Date)) |>  -->
<!--   group_by(Hyear, Scenario) |>  -->
<!--   summarise(Date = first(Date),  -->
<!--             Temp = mean(get(glacier))) |>  -->
<!--   separate(Scenario, into = c("GCM", "SSP"), sep = "_") |>  -->
<!--   ungroup() |> -->
<!--   dplyr::filter(Hyear > min(Hyear) & Hyear < max(Hyear),  -->
<!--                 GCM != "IPSL-CM6A-LR") -->
<!-- # Plot annual data for better readability -->
<!-- ggplot() +  -->
<!--   geom_line(data = hist_obs |>  -->
<!--               mutate(Hyear = hyear(date)) |>  -->
<!--               group_by(Hyear) |>  -->
<!--               summarise(date = first(date),  -->
<!--                         Temp = mean(get(glacier))) |>  -->
<!--               ungroup() |>  -->
<!--               dplyr::filter(Hyear > min(Hyear) & Hyear < max(Hyear)),  -->
<!--             aes(date, Temp)) +  -->
<!--   geom_line(data = fut_temp, aes(Date, Temp, colour = GCM,  -->
<!--             linetype = SSP)) +  -->
<!--   scale_colour_viridis_d() +  -->
<!--   labs(x = "Date", y = "T [deg C]") + -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- ### Glacier Geometry -->
<!-- ```{r} -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- # Load data -->
<!-- ## Digital elevation model (DEM) -->
<!-- dem <- raster(paste0(data_path, "GIS/16076_DEM.tif")) -->
<!-- ## Glacier outlines from the Randolph Glacier Inventory (RGI) v6.0  -->
<!-- rgi <- st_read(paste0(data_path, "GIS/16076_Glaciers_per_subbasin.shp"),  -->
<!--                quiet = TRUE) |>  -->
<!--   st_transform(crs = crs(dem)) -->
<!-- ## Outlines of hydrological response units for the modelling of glacier discharge.   -->
<!-- rgi_elbands <- st_read(paste0(data_path,  -->
<!--                               "GIS/rgi_glaciers_atbaschy_el_bands.shp"),  -->
<!--                quiet = TRUE) |>  -->
<!--   st_transform(crs = crs(dem)) -->
<!-- # Load a pre-processed raster file with glacier thickness in the Atbashy basin -->
<!-- # (see vignette [glaciers 01]{glaciers-01-intro.html} for details on the pre -->
<!-- # -processing) -->
<!-- glacier_thickness <- raster( -->
<!--   paste0(data_path,  -->
<!--   "GLACIERS/Farinotti/pre-processed_glacier_thickness.tif")) -->
<!-- # Load the glacier thickness data set and filter it to the glaciers in the  -->
<!-- # catchment of interest.   -->
<!-- hugonnet <- read_csv(paste0( -->
<!--   data_path, "/GLACIERS/Hugonnet/dh_13_rgi60_pergla_rates.csv")) -->
<!-- hugonnet <- hugonnet |>  -->
<!--   dplyr::filter(rgiid %in% rgi$RGIId) |>  -->
<!--   tidyr::separate(period, c("start", "end"), sep = "_") |>  -->
<!--   mutate(start = as_date(start, format = "%Y-%m-%d"),  -->
<!--          end = as_date(end, format = "%Y-%m-%d"),  -->
<!--          period = round(as.numeric(end - start, units = "days")/366)) -->
<!-- glaciers_hugonnet <- rgi |>  -->
<!--   left_join(hugonnet |> dplyr::select(rgiid, area, start, end, dhdt, err_dhdt,  -->
<!--                                       dvoldt, err_dvoldt, dmdt, err_dmdt,  -->
<!--                                       dmdtda, err_dmdtda, period),   -->
<!--             by = c("RGIId" = "rgiid"))  -->
<!-- # Only keep the variables we need for this analysis -->
<!-- rgi_elbands <- rgi_elbands |>  -->
<!--   dplyr::select(RGIId, Area, elvtn_b) |>  -->
<!--   rename(Area_tot_glacier_km2 = Area) |>  -->
<!--   mutate(ID = paste0(RGIId, "_", elvtn_b)) -->
<!-- # Get mean elevation of each glacier/elevation band from DEM -->
<!-- rgi_elbands$z_masl <- exact_extract(dem, rgi_elbands, "mean", progress = FALSE) -->
<!-- # Update the glacier area within the basin boundaries -->
<!-- rgi_elbands$A_km2 <- as.numeric(st_area(rgi_elbands))*10^(-6) -->
<!-- glaciers <- unique(rgi_elbands$RGIId) -->
<!-- # Calculate the average glacier thickness for each elevation band.  -->
<!-- rgi_elbands$thickness_m = exact_extract(glacier_thickness,  -->
<!--                                         rgi_elbands, "mean", progress = FALSE) -->
<!-- ``` -->
<!-- ### Processing of Forcing -->
<!-- Temperature time series for each glacier/elevation band are available. @fig-temperature-elevation-bands} shows temperature time series extracted from the CHELSA data set on the example of one of the larger glaciers in the Atbashy basin. The data is aggregated to the hydrological year to better illustrate the temperature gradient over the elevation. The highest temperatures are measured at the lowest elevations and vice versa. -->
<!-- ```{r} -->
<!-- #| label: fig-temperature-elevation-bands -->
<!-- #| fig-cap: "Temperature forcing for the elevation bands of a glacier. "  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- ggplot(hist_obs[, 1:9] |>  -->
<!--          pivot_longer(-date, names_to = "ID", values_to = "Temp") |>  -->
<!--          mutate(Hyear = hyear(date)) |>  -->
<!--          group_by(Hyear, ID) |>  -->
<!--          summarise(date = first(date),  -->
<!--                    Temp = mean(Temp))|>  -->
<!--          ungroup() |>  -->
<!--          dplyr::filter(Hyear>min(Hyear) & Hyear<max(Hyear)) |>  -->
<!--          left_join(rgi_elbands |>  -->
<!--                      st_drop_geometry() |>  -->
<!--                      dplyr::select(ID, z_masl), by = "ID") |>  -->
<!--          mutate("Elevation [masl]" = as.factor(round(z_masl)))) +  -->
<!--   geom_line(aes(date, Temp, colour = `Elevation [masl]`)) +  -->
<!--   scale_colour_viridis_d() +  -->
<!--   labs(x = "Date", y = "T [deg C]") +  -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- ### Calculating Glacier Melt -->
<!-- The code snippet below illustrates how to calculate the annual glacier melt of the catchment. @fig-glaciermeltcalculation shows daily melt rates for the different elevation bands of one of the larger glaciers (same as in the figure above). The highest melt occurs at low elevation bands. -->
<!-- ```{r} -->
<!-- #| label: fig-glaciermeltcalculation -->
<!-- #| fig-cap: "Daily glacier melt per elevation band."  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- MF_small = 1 -->
<!-- MF_large = 0.5 -->
<!-- threshold_temperature = 0 -->
<!-- Area <- rgi_elbands |>  -->
<!--   st_drop_geometry() |>  -->
<!--   dplyr::select(ID, A_km2) |>  -->
<!--   pivot_wider(names_from = ID, values_from = A_km2) -->
<!-- # Assign different melt factors to large and small glaciers.  -->
<!-- MF <- Area |>  -->
<!--   mutate(across(everything(), ~MF_large),  -->
<!--          across(ends_with("_1"), ~MF_small)) -->
<!-- melt <- glacierMelt_TI(temperature = hist_obs |> dplyr::select(-date), -->
<!--                        MF = MF, -->
<!--                        threshold_temperature = threshold_temperature) -->
<!-- melt <- as_tibble(melt) |>  -->
<!--   mutate(date = hist_obs$date) |>  -->
<!--   relocate(date, .before =  where(is.numeric)) -->
<!-- ggplot(melt[, 1:9] |>  -->
<!--          pivot_longer(-date, names_to = "ID", values_to = "Melt") |>  -->
<!--          left_join(rgi_elbands |>  -->
<!--                      st_drop_geometry() |>  -->
<!--                      dplyr::select(ID, z_masl), by = "ID") |>  -->
<!--          mutate("Elevation [masl]" = as.factor(round(z_masl)))) +  -->
<!--   geom_line(aes(date, Melt, colour = `Elevation [masl]`)) +  -->
<!--   scale_colour_viridis_d() +  -->
<!--   labs(x = "Date", y = "Melt [mm/d]") +  -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- ### Compare to Measured Glacier Melt -->
<!-- Aggregate the daily glacier melt to annual data and compare it to the observed glacier melt. Note that the glacier melt simulated with the temperature index model (sim) is never negative whereas the glacier mass change derived from @hugonnet_accelerated_2021 and @miles_health_2021 can be negative, indicating glacier growth.   -->
<!-- ```{r} -->
<!-- #| label: fig-glaciermeltcomparison -->
<!-- #| fig-cap: "Daily glacier melt per elevation band."  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- melt_a_eb <- melt |>  -->
<!--   pivot_longer(-date, names_to = "ID", values_to = "Melt") |>  -->
<!--   mutate(Hyear = hyear(date)) |>  -->
<!--   group_by(Hyear, ID) |>  -->
<!--   summarise(date = first(date),  -->
<!--             Melt = sum(Melt),  -->
<!--             .lb_Melt = ifelse(Melt*(1-error_stats$sMelt)<0, 0,  -->
<!--                               Melt*(1-error_stats$sMelt)),  -->
<!--             .ub_Melt = Melt*(1+error_stats$sMelt))|>  -->
<!--   ungroup()  -->
<!-- melt_a <- melt_a_eb |>  -->
<!--   separate(ID, into = c("RGIId", "elB"), sep = "_") |>  -->
<!--   group_by(Hyear, RGIId) |>  -->
<!--   summarise(date = as_date(first(date)),  -->
<!--             Melt = sum(Melt),  -->
<!--             .lb_Melt = ifelse(Melt*(1-error_stats$sMelt)<0, 0,  -->
<!--                               Melt*(1-error_stats$sMelt)),  -->
<!--             .ub_Melt = Melt*(1+error_stats$sMelt)) |>  -->
<!--   ungroup() |>  -->
<!--   dplyr::filter(Hyear > min(Hyear) & Hyear < max(Hyear)) -->
<!-- glaciers_hugonnet <- glaciers_hugonnet |>  -->
<!--   mutate(Qgl_m3a = glacierDischarge_HM(dhdt),  -->
<!--          .lb_Qgl_m3a = ifelse( -->
<!--            dhdt > 0,  -->
<!--            ifelse(Qgl_m3a*(1-error_stats$sQglgrowth)<0, 0,  -->
<!--                   Qgl_m3a*(1-error_stats$sQglgrowth)),  -->
<!--            ifelse(Qgl_m3a*(1-error_stats$sQglmelt)<0, 0,  -->
<!--                   Qgl_m3a*(1-error_stats$sQglmelt))), -->
<!--          .ub_Qgl_m3a = ifelse(dhdt > 0,  -->
<!--                               Qgl_m3a*(1+error_stats$sQglgrowth),  -->
<!--                               Qgl_m3a*(1+error_stats$sQglmelt))) -->
<!-- melt_obs_a <- glaciers_hugonnet |>  -->
<!--   dplyr::filter(RGIId %in% glaciers[6:9],  -->
<!--                 period == 1) -->
<!-- ggplot() +  -->
<!--   geom_ribbon(data = melt_a |>  -->
<!--                 dplyr::filter(RGIId %in% glaciers[6:9]),  -->
<!--               aes(date, Melt/1000, ymin = .lb_Melt/1000, ymax = .ub_Melt/1000,  -->
<!--                   fill = RGIId), colour = NA, alpha = 0.2) +  -->
<!--   geom_ribbon(data = melt_obs_a |>  -->
<!--                 dplyr::filter(RGIId %in% glaciers[6:9]),  -->
<!--               aes(start, -dmdtda,  -->
<!--                   ymin = -dmdtda-err_dmdtda,  -->
<!--                   ymax = -dmdtda+err_dmdtda,  -->
<!--                   colour = RGIId, linetype = "obs", fill = RGIId),  -->
<!--               size = 0.2, alpha = 0.2) +  -->
<!--   geom_line(data = melt_a |>  -->
<!--               dplyr::filter(RGIId %in% glaciers[6:9]),  -->
<!--             aes(date, Melt/1000, colour = RGIId, linetype = "sim")) +  -->
<!--   geom_line(data = melt_obs_a, aes(start, -dmdtda, colour = RGIId,  -->
<!--                                    linetype = "obs")) +  -->
<!--   labs(x = "Date", y = "Melt [m weq/a]") +  -->
<!--   scale_linetype_manual(name = "Source",  -->
<!--                         values = c("sim" = 1, "obs" = 2)) +  -->
<!--   scale_colour_viridis_d() +  -->
<!--   scale_fill_viridis_d() +  -->
<!--   ggtitle(paste0("MF: ", MF, "Tth: ", threshold_temperature)) +  -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- The temperature index model can be calibrated with the specific glacier volume change provided by @hugonnet_accelerated_2021 (see @fig-glaciermeltcomparison}). For the moment, manual calibration of the parameters is required.  -->
<!-- ### Glacier Mass Balance -->
<!-- The following figure shows the components of the glacier mass balance for a few glaciers in the Atbashy basin. -->
<!-- ```{r} -->
<!-- #| label: fig-glaciermassbalance -->
<!-- #| fig-cap: "Glacier area and volume development and total and imbalance discharge."  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- glacier_balance <- glacierBalance(melt_a_eb = melt_a_eb,  -->
<!--                                   rgi_elbands = rgi_elbands) -->
<!-- glacier_balance <- glacier_balance |>  -->
<!--   mutate(.lb = ifelse(Variable == "A_km2",  -->
<!--                       ifelse(Value*(1-error_stats$sA)>0,  -->
<!--                              Value*(1-error_stats$sA), 0),  -->
<!--                       ifelse(Variable == "V_km3",  -->
<!--                              ifelse(Value*(1-error_stats$sV)>0,  -->
<!--                                     Value*(1-error_stats$sV), 0),  -->
<!--                              ifelse(Variable == "Q_m3a",  -->
<!--                                     ifelse(Value*(1-error_stats$sQglmelt)>0, -->
<!--                                            Value*(1-error_stats$sQglmelt), 0),  -->
<!--                                     ifelse(Variable == "Qimb_m3a",  -->
<!--                                            Value*(1-error_stats$sImbal), NA)))),  -->
<!--          .ub = ifelse(Variable == "A_km2",  -->
<!--                       Value*(1+error_stats$sA),  -->
<!--                       ifelse(Variable == "V_km3",  -->
<!--                              Value*(1+error_stats$sV),  -->
<!--                              ifelse(Variable == "Q_m3a",  -->
<!--                                     Value*(1+error_stats$sQglmelt),  -->
<!--                                     ifelse(Variable == "Qimb_m3a",  -->
<!--                                            Value*(1+error_stats$sImbal), NA))))) -->
<!-- ggplot(glacier_balance |>  -->
<!--          dplyr::filter(RGIId %in% glaciers[6:9],  -->
<!--                        Hyear > min(Hyear) & Hyear < max(Hyear),  -->
<!--                        Variable %in% c("A_km2", "V_km3", "Q_m3a", "Qimb_m3a"))) +  -->
<!--   geom_ribbon(aes(Hyear, ymin = .lb, ymax = .ub, fill = RGIId),  -->
<!--               alpha = 0.2, colour = NA) +  -->
<!--   geom_line(aes(Hyear, Value, colour = RGIId)) +  -->
<!--   facet_wrap("Variable", scales = "free_y") +  -->
<!--   scale_colour_viridis_d() +  -->
<!--   scale_fill_viridis_d() +  -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- We now have glacier discharge (Q_m3s) and the unsustainable contribution to glacier discharge, the imbalance ablation (Qimb_m3a) which is negative for glacier loss and positive for growing glaciers. We are only interested in the contribution of imbalance ablation to river discharge, that is, only the negative part of Qimb_m3a is relevant to us. -->
<!-- ## From Annual to Daily Melt -->
<!-- The glacier mass balance is done on a yearly basis (if not at lower frequency). Hydrological models, however, typically run at higher frequency, for example monthly or daily time steps. One simple method to distribute glacier discharge on a year is to scale it according to the daily melt computed. -->
<!-- ```{r} -->
<!-- #| label: fig-imbalabl-daily -->
<!-- #| fig-cap: "Daily glacier discharge from imbalance ablation. "  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- # Aggregate the daily melt per glacier -->
<!-- melt_mmd <- melt |>  -->
<!--   pivot_longer(-date, names_to = "ID", values_to = "melt") |>  -->
<!--   separate(ID, into = c("RGIId", "elB"), sep = "_") |>  -->
<!--   group_by(date, RGIId) |>  -->
<!--   summarize(melt = sum(melt)) |>  -->
<!--   ungroup() |>  -->
<!--   rename(M_mmd = melt) -->
<!-- # Compute the annual melt per glacier  -->
<!-- melt_mma <- melt_mmd |>  -->
<!--   mutate(Hyear = hyear(date)) |>  -->
<!--   group_by(Hyear, RGIId) |>  -->
<!--   summarise(M_mma = sum(M_mmd)) |>  -->
<!--   ungroup() -->
<!-- # Rescale the annual imbalance glacier ablation with the daily melt rates -->
<!-- imbalAbl_m3s <- melt_mmd |>  -->
<!--   mutate(Hyear = hyear(date)) |>  -->
<!--   left_join(melt_mma, by = c("RGIId", "Hyear")) |>  -->
<!--   left_join(glacier_balance |>  -->
<!--               dplyr::filter(Variable == "Qimb_m3a") |>  -->
<!--               transmute(Hyear = Hyear,  -->
<!--                         RGIId = RGIId,  -->
<!--                         Qimba_m3s = -1* Value/(60*60*24*365)) |>  -->
<!--               mutate(Qimba_m3s = ifelse(Qimba_m3s < 0, 0, Qimba_m3s)),  -->
<!--             by = c("RGIId", "Hyear")) |>  -->
<!--   mutate(Qimb_m3s = Qimba_m3s * (M_mmd/M_mma),  -->
<!--          Qimb_m3s = ifelse(is.na(Qimb_m3s), 0, Qimb_m3s)) -->
<!-- # Visualise daily imbalance ablation -->
<!-- ggplot(imbalAbl_m3s |>  -->
<!--          dplyr::filter(RGIId %in% unique(glacier_balance$RGIId)[1:7])) +  -->
<!--   geom_line(aes(date, Qimb_m3s, colour = RGIId)) +  -->
<!--   scale_colour_viridis_d() +  -->
<!--   labs(x = "Date", y = "Glacier discharge from imbalance ablation [m3/s]") +  -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- # Aggregation to Sub-Basins -->
<!-- Glacier discharge can be aggregated to sub-basin in RSMinerve. For this, a GIS layer needs to be prepared manually in QGIS because typically, the RGI v6.0 glacier outlines are not consistent with the river basin boundaries derived from SRTM. In QGIS the sub-basin layer is intersected with the RGI layer and the boundaries between the sub-basins are manually adjusted to be consistent with the glacier outlines. This step is important as any glaciers which are cut by sub-basin boundaries and thus are present in two different sub-basins will be counted doubly. -->
<!-- ```{r} -->
<!-- #| label: fig-glaciersbysubbasin -->
<!-- #| fig-cap: "Glaciers coloured by sub-basin."  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- dem <- raster(paste0(data_path, "GIS/16076_DEM.tif")) -->
<!-- basin <- st_read(paste0(data_path, "GIS/16076_Basin_outline.shp"), quiet = TRUE) -->
<!-- hru <- st_read(paste0(data_path, "GIS/16076_HRU.shp"), quiet = TRUE) |>  -->
<!--   st_make_valid() |>  -->
<!--   mutate("Sub-basin" = gsub("_\\d*", "", name),  -->
<!--          "Sub-basin" = gsub("Subbasin", "", `Sub-basin`))  -->
<!-- rgi <- st_read(paste0(data_path, "GIS/16076_Glaciers_per_subbasin.shp"),  -->
<!--                quiet = TRUE) |>  -->
<!--   st_transform(crs = crs(dem)) -->
<!-- # Visualise glaciers coloured by sub-basin   -->
<!-- tmap_mode("view") -->
<!-- tmap_options(check.and.fix = TRUE) -->
<!-- #tm_shape(dem) + -->
<!-- #  tm_raster(n = 6,  -->
<!-- #            palette = terrain.colors(6), -->
<!-- #            alpha = 0.8, -->
<!-- #            legend.show = TRUE,  -->
<!-- #            title = "Elevation (masl)") +  -->
<!--   tm_shape(hru |> st_make_valid()) +  -->
<!--   tm_polygons(col = "Sub-basin", lwd = 0.6) +  -->
<!--   tm_shape(basin) +  -->
<!--   tm_borders(col = "black", lwd = 0.6) +  -->
<!--   tm_shape(rgi |> mutate("Glaciers" = gsub("_Subbasin", "", name_2))) +  -->
<!--   tm_polygons(col = "Glaciers", lwd = 1, border.col = "black") -->
<!-- ``` -->
<!-- The code junk below shows how to aggregate the daily per-glacier imbalance ablation rates to sub-basins. -->
<!-- ```{r} -->
<!-- #| label: fig-imbalAblSubbasin -->
<!-- #| fig-cap: "Glacier discharge from imbalance ablation aggregated to sub-basins. "  -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- Qimb_m3s_sub <- imbalAbl_m3s |> -->
<!--   dplyr::select(RGIId, date, Qimb_m3s) |> -->
<!--   left_join(rgi |>  -->
<!--               st_drop_geometry() |> -->
<!--               dplyr::select(RGIId, name_2)) |> -->
<!--   group_by(date, name_2) |> -->
<!--   summarise(Qimb_m3s = sum(Qimb_m3s, na.rm = TRUE)) |> -->
<!--   ungroup()  -->
<!-- ggplot(Qimb_m3s_sub |>  -->
<!--          mutate("Sub-basin" = gsub("_Subbasin", "", name_2))) +  -->
<!--   geom_line(aes(date, Qimb_m3s, colour = `Sub-basin`), alpha = 0.8) +  -->
<!--   scale_colour_viridis_d() +  -->
<!--   labs(x = "Date", y = "Glacier discharge from imbalance ablation [m3/s]") +  -->
<!--   theme_bw() -->
<!-- ``` -->
<!-- ## Writing Input File for RSMinerve -->
<!-- The input file format for RSMinerve is described in @rsminerve_tm, page 136. -->
<!-- ```{r} -->
<!-- #| eval: false -->
<!-- Q <- Qimb_m3s_sub |> -->
<!--   mutate(Qimb_m3s = round(Qimb_m3s, digits = 7)) -->
<!-- temp_wide <- Q |> -->
<!--   pivot_wider(names_from = name_2, values_from = Qimb_m3s) |>  -->
<!--   rename(Station = date)  -->
<!-- datechar <- posixct2rsminerveChar(temp_wide$Station)$value -->
<!-- datechar <- gsub(" 01:00:00", " 00:00:00", datechar) -->
<!-- datechar <- gsub(" 02:00:00", " 00:00:00", datechar) -->
<!-- output <- rbind(colnames(temp_wide), -->
<!--                 c("X", "1", "1", "1", "1"),  # Random coordinates, not relevant -->
<!--                 c("Y", "2", "2", "2", "3"),  -->
<!--                 c("Z", "3", "3", "3", "3"),  -->
<!--                 c("Sensor", "Q", "Q", "Q", "Q"),  -->
<!--                 c("Category", "Flow", "Flow", "Flow", "Flow"),  -->
<!--                 c("Unit", "m3/s", "m3/s", "m3/s", "m3/s"),  -->
<!--                 c("Interpolation", "Linear", "Linear", "Linear",  -->
<!--                   "Linear"),  -->
<!--                 cbind(datechar,  -->
<!--                       as.character(temp_wide$Dzhaldzhur_Subbasin),  -->
<!--                       as.character(temp_wide$Ulak_Subbasin),  -->
<!--                       as.character(temp_wide$Atbaschy_Midstream_Subbasin),  -->
<!--                       as.character(temp_wide$Atbaschy_Downstream_Subbasin))) -->
<!-- ``` -->
<!-- Finally, the prepared data is written to a csv file which can be read into RSMinerve.   -->
<!-- ```{r} -->
<!-- #| eval: false -->
<!-- writefilename <- paste0(data_path, "RSM_demo_glacier_source.csv") -->
<!-- write.table(output, file = writefilename, col.names = FALSE,  -->
<!--             row.names = FALSE, append = FALSE, quote = FALSE,  -->
<!--             sep = ",", dec = ".") -->
<!-- ``` -->
<!-- ## Implementation in RS Minerve -->
<!-- In RSMinerve, a source object is placed for each sub-basin containing glaciers. The RSMinerve input file written above is then read into the database and connected to the appropriate source objects in the model window. The RSMinerve model including glacier discharge can now be run.   -->
</section><section id="references" class="level2" data-number="11.4"><h2 data-number="11.4" class="anchored" data-anchor-id="references">
<span class="header-section-number">11.4</span> References</h2>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-benn_glaciers_2010" class="csl-entry" role="listitem">
Benn, Douglas I., and David J. A. Evans. 2010. <em>Glaciers &amp; Glaciation</em>. 2nd ed. London: Hodder education.
</div>
<div id="ref-cogley_glossary_2011" class="csl-entry" role="listitem">
Cogley, J. Graham, Regine Hock, B. Rasmussen, A. Arendt, A. Bauder, Roger J. Braithwaite, P. Jansson, et al. 2011. <span>“Glossary of <span>Glacier</span> <span>Mass</span> <span>Balance</span> and Related Terms.”</span> 86. Paris: UNESCO-IHP.
</div>
<div id="ref-erasov_1968" class="csl-entry" role="listitem">
Erasov, N. V. 1968. <span>“Method for Determining of Volume of Mountain Glaciers.”</span> <em>MGI</em>, no. 14: 307–8.
</div>
<div id="ref-farinotti_consensus_2019" class="csl-entry" role="listitem">
Farinotti, Daniel, Matthias Huss, Johannes J. Fürst, Johannes Landmann, Horst Machguth, Fabien Maussion, and Ankur Pandit. 2019. <span>“A Consensus Estimate for the Ice Thickness Distribution of All Glaciers on <span>Earth</span>.”</span> <em>Nature Geoscience</em> 12 (3): 168–73. <a href="https://doi.org/10.1038/s41561-019-0300-3">https://doi.org/10.1038/s41561-019-0300-3</a>.
</div>
<div id="ref-rsminerve_tm" class="csl-entry" role="listitem">
Garcia Hernandez, J., A. Foehn, J. Fluixa-Sanmartin, B. Roquier, T. Brauchli, J. Paredes Arquiola, and De Cesare G. 2020. <span>“RS MINERVE - Technical Manual, V2.25.”</span> ISSN 2673-2661. Switzerland: Ed. CREALP.
</div>
<div id="ref-hock_temperature_2003" class="csl-entry" role="listitem">
Hock, Regine. 2003. <span>“<span class="nocase">Temperature index melt modelling in mountain areas</span>.”</span> <em>Journal of Hydrology</em> 282 (1-4): 104–15. <a href="https://doi.org/10.1016/s0022-1694(03)00257-9">https://doi.org/10.1016/s0022-1694(03)00257-9</a>.
</div>
<div id="ref-hock_glacier_2005" class="csl-entry" role="listitem">
———. 2005. <span>“Glacier Melt: A Review of Processes and Their Modelling.”</span> <em>Progress in Physical Geography: Earth and Environment</em> 29 (3): 362–91. <a href="https://doi.org/10.1191/0309133305pp453ra">https://doi.org/10.1191/0309133305pp453ra</a>.
</div>
<div id="ref-pritchard_asias_2019" class="csl-entry" role="listitem">
Pritchard, Hamish D. 2019. <span>“Asia’s Shrinking Glaciers Protect Large Populations from Drought Stress.”</span> <em>Nature</em> 569 (7758): 649–54. <a href="https://doi.org/10.1038/s41586-019-1240-1">https://doi.org/10.1038/s41586-019-1240-1</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./modeling_using_predictive_inference.html" class="pagination-link  aria-label=" using="" predictive="" inference="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Modeling Using Predictive Inference</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Climate_change_impact_study.html" class="pagination-link" aria-label="<span class='chapter-number'>12</span>&nbsp; <span class='chapter-title'>Quantification of Climate Change Impacts</span>">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Quantification of Climate Change Impacts</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/hydrosolutions/caham_book/edit/master/glacier_modeling.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>